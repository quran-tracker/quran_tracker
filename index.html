<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Ù…ØªØ§Ø¨Ø¹Ø© Ø­ÙØ¸ Ø§Ù„Ù‚Ø±Ø¢Ù†</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg1:#fff7fb; --bg2:#ffffff; --card:#ffffff; --ink:#2d1f23; --muted:#7a6a6f;
      --line:#f1d8e3; --accent:#d96aa5; --accent2:#f6a6c8; --ok:#065f46;
      --shadow:0 14px 40px rgba(0,0,0,.07); --r:22px;
      --sans:"Tajawal",system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans Arabic","Noto Naskh Arabic",Arial,sans-serif;
    ;--navBlue:#4b83ff}
    *{box-sizing:border-box}
    body{margin:0;font-family:var(--sans);color:var(--ink);min-height:100vh;background:
      radial-gradient(1200px 600px at 10% 0%, rgba(217,106,165,.18), transparent 60%),
      radial-gradient(900px 500px at 90% 10%, rgba(246,166,200,.22), transparent 60%),
      linear-gradient(180deg, var(--bg1), var(--bg2) 55%);}
    .wrap{max-width:1160px;margin:26px auto;padding:18px}

    .hero{position:relative;border:1px solid var(--line);border-radius:var(--r);background:rgba(255,255,255,.78);box-shadow:var(--shadow);
      padding:18px 18px 14px;display:flex;align-items:center;justify-content:space-between;gap:14px;flex-wrap:wrap;}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:46px;height:46px;border-radius:16px;background:linear-gradient(135deg,var(--accent),var(--accent2));
      display:grid;place-items:center;color:white;font-weight:900;box-shadow:0 12px 24px rgba(217,106,165,.22);}
    h1{margin:0;font-size:20px}
    .right{display:flex;flex-direction:column;align-items:flex-end;gap:6px}
    .greet{font-weight:900}
    .metaLine{color:var(--muted);font-size:12px}

    /* top toast greeting (5s) */
    .toast{position:absolute;left:14px;right:14px;top:12px;display:none;justify-content:center;pointer-events:none;z-index:5;}
    .toast .list{display:flex;flex-direction:column;gap:10px;margin-top:10px}
    .item{border:1px solid var(--line);background:#fff;border-radius:16px;padding:12px;display:flex;align-items:center;justify-content:space-between;gap:10px}
    .item .meta{display:flex;flex-direction:column;gap:4px}
    .item .title{font-weight:900}
    .item .sub{font-size:12px;color:var(--muted)}
    .item .actions{display:flex;gap:8px;flex-wrap:wrap}
    .miniBtn{border:1px solid var(--line);background:#fff;border-radius:12px;padding:8px 10px;cursor:pointer;font-weight:900}
    .miniBtn.primary{background:rgba(217,106,165,.12);border-color:rgba(217,106,165,.25)}
    .miniBtn:active{transform:scale(.99)}
    .pill{pointer-events:none;max-width:760px;width:fit-content;background:rgba(255,255,255,.92);
      border:1px solid var(--line);border-radius:999px;padding:10px 14px;box-shadow:0 10px 26px rgba(0,0,0,.08);
      font-weight:900}
    .toast.show{display:flex;animation:fadeIn .18s ease-out}
    @keyframes fadeIn{from{transform:translateY(-6px);opacity:0}to{transform:translateY(0);opacity:1}}

    .card{margin-top:16px;border:1px solid var(--line);border-radius:var(--r);background:var(--card);box-shadow:var(--shadow);overflow:hidden;}
    .cardHd{padding:16px 18px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;}
    .cardHd h2{margin:0;font-size:16px}
    .muted{color:var(--muted);font-size:13px}
    .body{padding:18px}
    .split{display:grid;grid-template-columns:1.15fr .85fr;gap:16px}
    @media (max-width:860px){.split{grid-template-columns:1fr}}
    .panel{border:1px solid var(--line);border-radius:18px;padding:16px;background:linear-gradient(180deg, rgba(255,255,255,.95), #fff);}
    .btn{width:100%;display:flex;align-items:center;justify-content:center;gap:10px;border:none;border-radius:14px;
      padding:12px 12px;cursor:pointer;font-weight:800;font-family:inherit;transition:transform .05s ease;user-select:none;}
    .btn:active{transform:scale(.99)}
    .btnPrimary{background:linear-gradient(135deg,var(--accent),var(--accent2));color:white;box-shadow:0 12px 18px rgba(217,106,165,.18);}
    .btnGhost{background:#fff;color:var(--ink);border:1px solid var(--line);}
    .btnLink{background:transparent;border:none;padding:0;width:auto;color:var(--accent);font-weight:800;cursor:pointer;}
    .btnSmall{width:auto;padding:10px 12px;border-radius:12px;font-weight:800}
    .field{display:flex;flex-direction:column;gap:7px;margin-top:10px}
    label{font-size:12px;color:var(--muted)}
    input,textarea{font:inherit;border:1px solid var(--line);border-radius:14px;padding:11px 12px;outline:none;background:#fff;}
    input:focus,textarea:focus{border-color:rgba(217,106,165,.7);box-shadow:0 0 0 4px rgba(217,106,165,.12);}
    textarea{min-height:86px;resize:vertical}
    .row{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;margin-top:10px}
    .status{margin-top:12px;border-radius:14px;padding:10px 12px;border:1px solid var(--line);color:var(--muted);font-size:13px;background:#fff;}
    .status.ok{border-color:#a6f4c5;background:#f6fef9;color:var(--ok)}
    .status.warn{border-color:#fda29b;background:#fff5f5;color:#7a1f1a}
    .actions{display:flex;gap:10px;flex-wrap:wrap;align-items:center}

    .partsGrid{display:grid;grid-template-columns:repeat(6,1fr);gap:10px;padding:16px 18px}
    @media (max-width:980px){.partsGrid{grid-template-columns:repeat(4,1fr)}}
    @media (max-width:620px){.partsGrid{grid-template-columns:repeat(3,1fr)}}
    .partBtn{border:1px solid var(--line);background:#fff;border-radius:16px;padding:12px 10px;cursor:pointer;display:flex;flex-direction:column;gap:6px;align-items:flex-start;box-shadow:0 10px 18px rgba(0,0,0,.04);}
    .partBtn:hover{border-color:rgba(217,106,165,.55)}
    /* part selected (picker + modal) */
    .partBtn.active{
      border-color:rgba(217,106,165,.95);
      background:rgba(217,106,165,.12);
      box-shadow:0 12px 20px rgba(217,106,165,.14);
    }
    .partNum{font-weight:900;font-size:16px}
    .partMeta{color:var(--muted);font-size:12px}
    .tag{font-size:11px;border:1px solid var(--line);border-radius:16px;padding:6px 10px;color:var(--muted);text-align:center;line-height:1.35;}

    .tableWrap{overflow:auto}
    table{width:100%;border-collapse:separate;border-spacing:0}
    th,td{padding:10px 12px;border-bottom:1px solid var(--line);vertical-align:top}
    th{position:sticky;top:0;background:#fff;color:var(--muted);font-size:12px;text-align:center}
    .thSub{margin-top:4px;color:var(--muted);font-size:11px}

    .circles{display:grid;gap:6px;align-content:start;justify-content:center}
    .grid5{grid-template-columns:repeat(5, 18px)}
    .grid3{grid-template-columns:repeat(3, 18px)}
    .grid2{grid-template-columns:repeat(2, 18px)}
    .c{width:18px;height:18px;border-radius:999px;border:2px solid rgba(217,106,165,.45);background:transparent;cursor:pointer}
    .c.on{background:linear-gradient(135deg,var(--accent),var(--accent2));border-color:transparent}

    /* tasmee3 checkbox - pink, no label */
    .tasmee3Box{width:20px;height:20px;accent-color: var(--accent); cursor:pointer;}

    .chk{display:flex;align-items:center;gap:8px}
    .chk input{width:18px;height:18px;accent-color: var(--accent);}
    .hide{display:none!important}
    .footer{margin-top:12px;color:var(--muted);font-size:12px;display:flex;justify-content:space-between;flex-wrap:wrap;gap:10px}

    /* overlays */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.22);display:grid;place-items:center;padding:18px;z-index:50}
    /* Avoid modals being cut off on small screens */
    .modal{width:min(640px,100%);max-height:calc(100dvh - 36px);border-radius:22px;background:#fff;border:1px solid var(--line);box-shadow:var(--shadow);overflow:hidden;display:flex;flex-direction:column}
    .modalHd{padding:16px 18px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:flex-start;gap:10px;flex:0 0 auto}
    .modalBd{padding:18px;overflow:auto;flex:1 1 auto}
    @media (max-width:980px){
      .overlay{padding:14px 14px calc(14px + 90px + env(safe-area-inset-bottom));}
      .modal{max-height:calc(100dvh - (28px + 90px + env(safe-area-inset-bottom)));}
    }
    .stepDots{display:flex;gap:6px;align-items:center;margin-top:4px}
    .dot{width:8px;height:8px;border-radius:999px;border:1px solid var(--line);background:#fff}
    .dot.on{background:linear-gradient(135deg,var(--accent),var(--accent2));border-color:transparent}
    .mini{font-size:12px;color:var(--muted)}
  

/* App shell + sidebar (fixed edge) */
.appShell{display:flex;align-items:flex-start;gap:16px;margin-top:16px}
.mainArea{min-width:0;flex:1}

/* Sidebar structure */
.sideInner{display:flex;flex-direction:column;height:100%}
.sideSpacer{flex:1}
.sideBottom{margin-top:12px}

/* Desktop: fixed full-height sidebar on the far right */
.sideBar{
  position:fixed;
  top:26px;
  right:18px;
  height:calc(100vh - 52px);
  width:264px;
  padding:16px 12px;
  border:1px solid var(--line);
  border-radius:var(--r);
  background:rgba(255,255,255,.90);
  backdrop-filter: blur(8px);
  z-index:120; /* ÙÙˆÙ‚ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ */
  overflow:auto;
}
/* Ø§ØªØ±ÙƒÙŠ Ù…Ø³Ø§Ø­Ø© Ø¨Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø­ØªÙ‰ Ù„Ø§ ÙŠÙ†ØºØ·ÙŠ ØªØ­Øª Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© */
.wrap{padding-right: calc(264px + 34px);}

.sideHead{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:10px}
.sideTitle{font-weight:900;font-size:14px;color:var(--ink)}
.collapseBtn{width:auto;padding:8px 10px;border-radius:12px}
.nav{display:flex;flex-direction:column;gap:8px;margin-top:10px}

.navBtn{
  display:flex;align-items:center;gap:10px;
  border:1px solid transparent;
  background:transparent;
  border-radius:14px;
  padding:10px 10px;
  cursor:pointer;
  font-weight:800;
  font-family:inherit;
  color:var(--ink);
  transition:background .12s ease, border-color .12s ease, transform .05s ease;
  width:100%;
  text-align:right;
}
.navBtn:hover{background:rgba(217,106,165,.08)}
.navBtn:active{transform:scale(.99)}
.navBtn.active{
  background:rgba(217,106,165,.12);
  border-color:rgba(217,106,165,.25);
}

/* Bigger icons + pink */
.navIcon{
  width:22px;height:22px;display:inline-grid;place-items:center;
  color:var(--accent);
  font-weight:900;
  flex:0 0 22px;
}
.navIcon svg{width:22px;height:22px;display:block}
.navBtn span.txt{font-size:13px}

.sideBar.collapsed{width:76px;padding:14px 10px}
.sideBar.collapsed .sideTitleText{display:none}
.sideBar.collapsed .navBtn span.txt{display:none}
.sideBar.collapsed .navBtn{justify-content:center}
.sideBar.collapsed .nav{gap:10px}
.sideBar.collapsed .sideHead{justify-content:center}

/* Update wrap padding when collapsed */
body.sidebarCollapsed .wrap{padding-right: calc(76px + 18px);}

/* Mobile bottom navigation */
.bottomNav{
  display:none;
  position:fixed;
  left:0; right:0; bottom:0;
  background:rgba(255,255,255,.92);
  border-top:1px solid var(--line);
  box-shadow:0 -10px 22px rgba(0,0,0,.06);
  padding:10px 14px;
  z-index:90;
  backdrop-filter: blur(10px);
}
.bottomNavInner{max-width:520px;margin:0 auto;display:flex;justify-content:space-around;gap:10px}
.bottomBtn{
  border:0;background:transparent;cursor:pointer;font-family:inherit;
  display:flex;flex-direction:column;align-items:center;gap:6px;
  padding:6px 10px;border-radius:14px;
  color:var(--muted);font-weight:800;font-size:11px;
  min-width:84px;
}
.bottomBtn .ico{width:22px;height:22px;display:grid;place-items:center;color:var(--accent)}
.bottomBtn.active{background:rgba(217,106,165,.12);color:var(--ink)}
.bottomBtn.active .ico{color:var(--accent)}

/* Bottom sheet (More) */
.sheetBackdrop{
  position:fixed; inset:0;
  background:rgba(0,0,0,.28);
  display:none; z-index:95;
}
.sheetBackdrop.show{display:block}
.bottomSheet{
  position:fixed; left:0; right:0; bottom:-420px;
  background:#fff;
  border-top-left-radius:20px;
  border-top-right-radius:20px;
  border:1px solid var(--line);
  box-shadow:0 -18px 40px rgba(0,0,0,.12);
  padding:14px 14px 18px;
  z-index:96;
  transition:bottom .18s ease;
}
.bottomSheet.show{bottom:0}
.sheetHandle{width:44px;height:5px;border-radius:999px;background:rgba(0,0,0,.12);margin:0 auto 12px}
.sheetItem{width:100%;text-align:right;border:1px solid var(--line);background:#fff;border-radius:14px;
  padding:12px 12px;cursor:pointer;font-weight:900}
.sheetItem:active{transform:scale(.99)}

/* Responsive switch */
@media (max-width:980px){
  .wrap{padding-right:18px;padding-bottom:86px;} /* space for bottom nav */
  body.sidebarCollapsed .wrap{padding-right:18px;}
  .sideBar{display:none;}
  .bottomNav{display:block;}
}

/* Backdrop kept (used for sheet too) */
.backdrop{position:fixed;inset:0;background:rgba(0,0,0,.25);display:none;z-index:78}
.backdrop.show{display:block}

.view{display:none !important;}
.view.show{display:block !important;}

    .backdrop{position:fixed;inset:0;background:rgba(0,0,0,.25);display:none;z-index:55}    .backdrop{position:fixed;inset:0;background:rgba(0,0,0,.22);display:none;z-index:55}
    .backdrop.show{display:block}
    .view{display:none}
    .view.show{display:block}

/* ===== v24_40: Soft part colors with correct logic =====
   - default (no class): not started
   - partInProgress: started but not finished (pink)
   - partMemDone: memorized 100% but fixation <100 (orange)
   - partFixDone: memorized 100% and fixation 100% (green)
*/
.partBtn.partInProgress{
  background:#fde7f3 !important;
  border-color:#f5a5c8 !important;
}
.partBtn.partMemDone{
  background:#fff1df !important;
  border-color:#f6b26b !important;
}
.partBtn.partFixDone{
  background:#e9f7ef !important;
  border-color:#8fd19e !important;
}



/* Member progress ring (beside member name) */
.progRing{
  --p:0;
  width:42px;height:42px;border-radius:999px;
  background: conic-gradient(var(--accent) calc(var(--p)*1%), rgba(217,106,165,.18) 0);
  display:grid;place-items:center;
  position:relative;
  flex:0 0 42px;
}
.progRing::before{
  content:"";
  position:absolute;inset:4px;
  background:#fff;border-radius:999px;
  border:1px solid rgba(241,216,227,.9);
}
.progRing > span{
  position:relative;
  font-size:11px;
  font-weight:900;
  color:var(--ink);
}
.progRing.empty{background:rgba(217,106,165,.10)}
@media (max-width:600px){
  .progRing{width:38px;height:38px;flex-basis:38px}
  .progRing::before{inset:4px}
  .progRing > span{font-size:10px}
}

/* ===== v24_50 Rank next to name (inside title) ===== */
.rankBadge{
  min-width:22px;
  height:22px;
  border-radius:999px;
  background:#fde7f3;
  color:#7a294e;
  font-weight:800;
  font-size:12px;
  display:flex;
  align-items:center;
  justify-content:center;
  flex:0 0 22px;
}
.item .title.titleFlex{
  display:flex;
  align-items:center;
  gap:8px;
  justify-content:flex-start; /* in RTL => right */
}

</style>
</head>
<body>
  <aside class="sideBar" id="sideBar"><div class="sideInner">
    <div class="sideHead">
      <div class="sideTitle"><span class="sideTitleText">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</span></div>
      <button class="btn btnGhost collapseBtn" id="collapseBtn" type="button">â®â®</button>
    </div>

    <div class="nav">
      <button class="navBtn active" id="navMy" type="button">
        <span class="navIcon"><svg viewBox="0 0 24 24" width="22" height="22" aria-hidden="true"><path fill="currentColor" d="M12 12a4.2 4.2 0 1 0-4.2-4.2A4.2 4.2 0 0 0 12 12Zm0 2c-4.1 0-7.5 2.2-7.5 5v1h15v-1c0-2.8-3.4-5-7.5-5Z"/></svg></span><span class="txt">ØµÙØ­ØªÙŠ</span>
      </button>
      <button class="navBtn" id="navGroups" type="button">
        <span class="navIcon"><svg viewBox="0 0 24 24" width="22" height="22" aria-hidden="true"><path fill="currentColor" d="M16.5 13c-2.6 0-4.8 1.3-5.5 3.2.6.7 1 1.5 1 2.3V20h9v-1.5c0-3-2.2-5.5-4.5-5.5ZM8.5 13c-3.3 0-6 2-6 4.5V20h9v-1.5c0-2.5-2.7-5.5-3-5.5Zm0-2a3 3 0 1 0-3-3 3 3 0 0 0 3 3Zm8 0a2.5 2.5 0 1 0-2.5-2.5A2.5 2.5 0 0 0 16.5 11Z"/></svg></span><span class="txt">Ù…Ø¬Ù…ÙˆØ¹Ø§ØªÙŠ</span>
      </button>
</div>

    <div class="sideSpacer"></div>
        <div class="sideBottom">
      <button class="navBtn" id="navLogout" type="button">
        <span class="navIcon">ğŸšª</span><span class="txt">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</span>
      </button>
    </div>
  </div></aside>

  <div class="wrap">
    <div class="hero">
      <div class="toast" id="toast"><div class="pill" id="toastText"></div></div>

      <div class="brand">
        <div class="logo">Ù‚</div>
        <div><h1>Ù…ØªØ§Ø¨Ø¹Ø© Ø­ÙØ¸ Ø§Ù„Ù‚Ø±Ø¢Ù†</h1></div>
      </div>
      <div class="right">
        <div id="greet" class="greet"></div>
        <div id="globalLast" class="metaLine"></div>
      </div>
    
    </div>

<div class="backdrop" id="backdrop"></div>

<div class="appShell">

  <main class="mainArea">
    <section class="view show" id="viewMy">
<!-- Intro Wizard -->
    <div id="introOverlay" class="overlay hide">
      <div class="modal">
        <div class="modalHd">
          <div>
            <div id="introTitle" style="font-weight:900;font-size:16px">ğŸŒ¸</div>
            <div id="introSub" class="mini" style="margin-top:6px"></div>
            <div class="stepDots" id="dots"></div>
          </div>
          <button class="btn btnGhost btnSmall" id="closeIntroBtn" style="width:auto">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
        <div class="modalBd">
          <div id="introBody" style="line-height:1.85"></div>
          <div class="row" style="margin-top:16px">
            <button class="btn btnGhost btnSmall" id="prevIntroBtn" style="width:auto">Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
            <button class="btn btnPrimary btnSmall" id="nextIntroBtn" style="width:auto">Ø§Ù„ØªØ§Ù„ÙŠ</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Name Modal (first time) -->
    <div id="nameOverlay" class="overlay hide">
      <div class="modal">
        <div class="modalHd">
          <div>
            <div style="font-weight:900;font-size:16px">Ø£Ù‡Ù„Ù‹Ø§ ÙÙŠ Ø§Ù„Ø­Ù„Ù‚Ø© ğŸŒ¸</div>
            <div class="mini" style="margin-top:6px">Ø§ÙƒØªØ¨ÙŠ Ø§Ø³Ù…Ùƒ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·ØŒ ÙˆØ¨Ø¹Ø¯Ù‡Ø§ Ø±Ø­ Ù†Ø±Ø­Ù‘Ø¨ ÙÙŠÙƒ ÙÙŠÙ‡.</div>
          </div>
          <button class="btn btnGhost btnSmall" id="skipNameBtn" style="width:auto">ØªØ®Ø·ÙŠ</button>
        </div>
        <div class="modalBd">
          <div class="field">
            <label>Ø§Ø³Ù…Ùƒ</label>
            <input id="displayName" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø±ÙŠÙ…" />
          </div>
          <div class="row" style="margin-top:14px">
            <button class="btn btnPrimary btnSmall" id="saveNameBtn" style="width:auto">Ø­ÙØ¸</button>
          </div>
          <div class="status" id="nameStatus" style="margin-top:12px">âœ¨</div>
        </div>
      </div>
    </div>

    <!-- LOGIN -->
    <div id="authCard" class="card">
      <div class="cardHd"><h2>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2><div class="muted">Ø§Ø®ØªØ§Ø±ÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø£Ù†Ø³Ø¨ Ù„Ùƒ.</div></div>
      <div class="body split">
        <div class="panel">
          <div class="muted" style="margin-bottom:10px">Ø§Ù„Ø£Ø³Ø±Ø¹: Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø­Ø³Ø§Ø¨ Google</div>
          <button class="btn btnGhost" id="googleBtn">
            <svg width="22" height="22" viewBox="0 0 48 48" aria-hidden="true">
              <path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.2C12.43 13.08 17.74 9.5 24 9.5z"/>
              <path fill="#4285F4" d="M46.98 24.55c0-1.57-.14-3.09-.4-4.55H24v9.02h12.94c-.56 3.02-2.25 5.58-4.79 7.3l7.73 5.99C44.41 38.3 46.98 31.97 46.98 24.55z"/>
              <path fill="#FBBC05" d="M10.54 28.42c-.48-1.45-.76-2.99-.76-4.42s.27-2.97.76-4.42l-7.98-6.2C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.62l7.98-6.2z"/>
              <path fill="#34A853" d="M24 48c6.48 0 11.93-2.14 15.91-5.81l-7.73-5.99c-2.15 1.45-4.9 2.3-8.18 2.3-6.26 0-11.57-3.58-13.47-8.63l-7.98 6.2C6.51 42.62 14.62 48 24 48z"/>
            </svg>
            Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Google
          </button>
          <div class="status" id="authStatus">Ø³Ø¬Ù‘Ù„ÙŠ Ø¯Ø®ÙˆÙ„Ùƒ ÙˆØ§Ø¨Ø¯Ø¦ÙŠ ğŸŒ¸</div>
          <div class="row" style="margin-top:12px"><span class="muted">Ø¨Ø¯ÙˆÙ† GoogleØŸ</span><button class="btnLink" id="showEmailBtn">Ø§Ø³ØªØ®Ø¯Ù…ÙŠ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ + ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±</button></div>
        </div>

        <div class="panel" id="emailPanel" style="display:none">
          <div class="muted" style="margin-bottom:6px">Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</div>
          <div class="field"><label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label><input id="email" placeholder="name@gmail.com" autocomplete="email"/></div>
          <div class="field"><label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label><input id="password" type="password" placeholder="********" autocomplete="current-password"/></div>
          <div class="row">
            <button class="btn btnPrimary btnSmall" id="signInBtn" style="width:auto">Ø¯Ø®ÙˆÙ„</button>
            <button class="btn btnGhost btnSmall" id="signUpBtn" style="width:auto">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
          </div>
          <div class="row"><button class="btnLink" id="resetPwBtn">Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±ØŸ</button><button class="btnLink" id="hideEmailBtn">Ø±Ø¬ÙˆØ¹</button></div>
        </div>
      </div>
    </div>

    <!-- DASHBOARD -->
    <div id="dash" class="card hide">
      <div class="cardHd">
        <div><h2>Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡</h2><div class="muted">Ø§Ø®ØªØ§Ø±ÙŠ Ø¬Ø²Ø¡Ù‹Ø§ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©</div></div>
        <div class="actions">
          <button class="btn btnGhost btnSmall" id="helpBtn" style="width:auto">Ø´Ø±Ø­ Ø§Ù„Ù†Ø¸Ø§Ù…</button>
          <button class="btn btnGhost btnSmall" id="logoutBtn2" style="width:auto">Ø®Ø±ÙˆØ¬</button>
        </div>
      </div>
      <div class="partsGrid" id="partsGrid"></div>
    </div>

    <!-- PART VIEW -->
    <div id="partView" class="card hide">
      <div class="cardHd">
        <div>
          <h2 id="partTitle">Ø§Ù„Ø¬Ø²Ø¡</h2>
          <div class="muted" id="partSubtitle">ØµÙØ­Ø§Øª Ø§Ù„Ø¬Ø²Ø¡</div>
        </div>
        <div class="actions">
          <button class="btn btnGhost btnSmall" id="backBtn" style="width:auto">Ø±Ø¬ÙˆØ¹</button>
          <button class="btn btnGhost btnSmall" id="logoutBtn" style="width:auto">Ø®Ø±ÙˆØ¬</button>
        </div>
      </div>

      <div style="padding:12px 18px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center">
        <div class="chk">
          <input id="partTasmee3" type="checkbox"/>
          <label for="partTasmee3" style="margin:0">ØªØ³Ù…ÙŠØ¹ Ø§Ù„Ø¬Ø²Ø¡ ØºÙŠØ¨Ù‹Ø§</label>
        </div>
        <div class="chk">
          <input id="partTest" type="checkbox"/>
          <label for="partTest" style="margin:0">Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…ÙˆØ§Ø¶Ø¹ (Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¬Ø²Ø¡)</label>
        </div>
        <div class="metaLine" id="lastSaved">Ø¢Ø®Ø± ØªØ¹Ø¯ÙŠÙ„: â€”</div>
      </div>

      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th style="min-width:90px">Ø±Ù‚Ù… Ø§Ù„ØµÙØ­Ø©</th>

              <th style="min-width:220px">
                ØªÙ„Ø§ÙˆØ© ØºÙŠØ¨Ù‹Ø§
                <div class="thSub">10 Ù…Ø±Ø§Øª</div>
              </th>

              <th style="min-width:200px">
                Ù…Ø±Ø§Ø¬Ø¹Ø© Ù‚Ø±ÙŠØ¨Ø©
                <div class="thSub">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø£ÙˆÙ„</div>
              </th>

              <th style="min-width:180px">
                Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¨Ø¹ÙŠØ¯Ø©
                <div class="thSub">Ø®Ù„Ø§Ù„ Ø§Ù„Ø´Ù‡Ø±</div>
              </th>

              <th style="min-width:140px">
                ØªØ³Ù…ÙŠØ¹
              </th>

              <th style="min-width:240px">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>

      <div style="padding:14px 18px;border-top:1px solid var(--line)">
        <div class="field"><label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù„Ù„Ø¬Ø²Ø¡</label><textarea id="details" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ..."></textarea></div>
        <div class="footer">
          <div class="muted">Ø§Ù„Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ âœ¨</div>
          
        </div>

      </div>
    </div>
  </div>
</section>

<section class="view" id="viewGroups">
  <div class="card">
    <div class="cardHd">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
        <h2 style="margin:0">Ù…Ø¬Ù…ÙˆØ¹Ø§ØªÙŠ</h2>
        <button class="btn" id="goCreateFromGroups" type="button">Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù…ÙˆØ¹Ø©</button>
      </div>
    </div>
    <div class="body">
      <div class="panel" style="margin-bottom:10px">
        <div style="font-weight:900;margin-bottom:6px">Ø¯Ø¹ÙˆØ§ØªÙŠ</div>
        <div class="muted" style="margin-bottom:10px">Ø¥Ø°Ø§ ÙÙŠ Ø¨Ù†Øª Ø¯Ø¹ØªÙƒ Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©ØŒ Ø¨ØªØ¸Ù‡Ø± Ù‡ÙˆÙ†. Ø§Ø¶ØºØ·ÙŠ Ù‚Ø¨ÙˆÙ„ Ù„Ù„Ø¯Ø®ÙˆÙ„.</div>
        <div id="invitesList" class="list"></div>
        <div id="invitesEmpty" class="muted" style="display:none">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯Ø¹ÙˆØ§Øª Ø­Ø§Ù„ÙŠØ§Ù‹.</div>
      </div>

      <div class="panel">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
          <div style="font-weight:900">Ù…Ø¬Ù…ÙˆØ¹Ø§ØªÙŠ</div>
          <button class="btn btnGhost" id="refreshGroups" type="button">ØªØ­Ø¯ÙŠØ«</button>
        </div>
        <div class="muted" style="margin:8px 0 10px">Ø§Ø¶ØºØ·ÙŠ Ø¹Ù„Ù‰ Ø£ÙŠ Ù…Ø¬Ù…ÙˆØ¹Ø© Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¯Ø¹ÙˆØ§Øª (Ù‚Ø±ÙŠØ¨Ù‹Ø§: ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¨Ù†Ø§Øª ÙˆØ§Ù„ØªÙ‚Ø¯Ù…).</div>
        <div id="myGroupsList" class="list"></div>
        <div id="myGroupsEmpty" class="muted" style="display:none">Ù„Ø³Ø§ Ù…Ø§ Ø§Ù†Ø¶Ù…Ù‘ÙŠØªÙŠ Ù„Ø£ÙŠ Ù…Ø¬Ù…ÙˆØ¹Ø©.</div>
      </div>
    </div>
  </div>
</section>

    <section class="view" id="viewGroup">
  <div class="card">
    <div class="cardHd">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
        <div>
          <h2 style="margin:0" id="groupTitle">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</h2>
          <div class="muted" id="groupSub">...</div>
        </div>
        <button class="btn btnGhost" id="backToGroupsFromGroup" type="button">Ø±Ø¬ÙˆØ¹</button>
      </div>
    </div>
    <div class="body">

      <div class="panel" id="myPartsSummaryPanel" style="margin-bottom:12px">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
          <div>
            <div style="font-weight:900;margin-bottom:6px">Ø£Ø¬Ø²Ø§Ø¦ÙŠ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</div>
            <div class="muted" id="myPartsSummaryText">...</div>
          </div>
          <button class="btn" id="editMyPartsBtn" type="button">Ø§Ø®ØªÙŠØ§Ø± / ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡</button>
        </div>
      </div>
      <div class="panel" id="pickPartsPanel" style="display:none"margin-bottom:12px">
        <div style="font-weight:900;margin-bottom:6px">Ø§Ø®ØªØ§Ø±ÙŠ Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡ Ø§Ù„Ø®Ø§ØµØ© ÙÙŠÙƒ</div>
        <div class="muted" id="pickPartsHint" style="margin-bottom:10px">Ø§Ø®ØªØ§Ø±ÙŠ Ø¨Ø§Ù„Ø¶Ø¨Ø· N Ø£Ø¬Ø²Ø§Ø¡ Ù„Ù‡Ø¯ÙÙƒ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©.</div>

        <div id="partsPickerGrid" class="partsGrid"></div>

        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;align-items:center;justify-content:space-between">
          <div class="muted" id="partsPickerCount">0 / 0</div>
          <button class="btn" id="savePickedParts" type="button">Ø­ÙØ¸ Ø§Ø®ØªÙŠØ§Ø±ÙŠ</button>
        </div>
      </div>

      <div class="panel" style="margin-bottom:12px">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
          <div style="font-weight:900">Ø¯Ø¹ÙˆØ© Ø¹Ø¶ÙˆØ©</div>
        </div>
        <div class="muted" style="margin:6px 0 10px">Ø§ÙƒØªØ¨ÙŠ Ø¥ÙŠÙ…ÙŠÙ„Ù‡Ø§. Ø³ØªØ¸Ù‡Ø± Ù„Ù‡Ø§ Ø¯Ø¹ÙˆØ© ÙÙŠ â€œØ¯Ø¹ÙˆØ§ØªÙŠâ€ Ù„ØªÙ‚Ø¨Ù„ Ø£Ùˆ ØªØ±ÙØ¶.</div>
        <div style="display:grid;grid-template-columns:1fr 120px;gap:10px;align-items:end">
          <input id="groupInviteEmail" class="in" placeholder="name@gmail.com" />
          <button class="btn" id="groupSendInvite" type="button">Ø¥Ø±Ø³Ø§Ù„</button>
        </div>

        <div style="margin-top:10px">
          <div class="muted" style="margin-bottom:6px">Ø§Ù„Ø¯Ø¹ÙˆØ§Øª Ø§Ù„Ù…Ø±Ø³Ù„Ø©</div>
          <div id="groupInvitesList" class="list"></div>
          <div id="groupInvitesEmpty" class="muted" style="display:none">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯Ø¹ÙˆØ§Øª Ø¨Ø¹Ø¯.</div>
        </div>
      </div>

      <div class="panel">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
          <div style="font-weight:900">Ø§Ù„Ø¹Ø¶ÙˆØ§Øª</div>
          
        </div>
        <div class="muted" style="margin-top:6px">Ù‡Ù†Ø§ Ø³Ù†Ø¹Ø±Ø¶ Ø§Ù„ØªØ±ØªÙŠØ¨ ÙˆØ§Ù„Ù†Ù‘ÙØ³ÙØ¨ Ù„Ø§Ø­Ù‚Ù‹Ø§. Ø­Ø§Ù„ÙŠØ§Ù‹ Ù†Ø¹Ø±Ø¶ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø¹Ø¶ÙˆØ§Øª ÙÙ‚Ø·.</div>
        <div id="groupMembersList" class="list"></div>
        <div id="groupMembersEmpty" class="muted" style="display:none">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø¹Ø¶Ø§Ø¡ Ø¨Ø¹Ø¯.</div>
      </div>
    </div>
  </div>
</section>

<section class="view" id="viewCreate">
  <div class="card">
    <div class="cardHd">
      <div>
        <h2>Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù…ÙˆØ¹Ø©</h2>
        <div class="muted">Ù‡Ø¯Ù Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø¢Ù†: Ø¹Ø¯Ø¯ Ø£Ø¬Ø²Ø§Ø¡ (N). ÙƒÙ„ Ø¹Ø¶ÙˆØ© ØªØ®ØªØ§Ø± Ø¨Ø§Ù„Ø¶Ø¨Ø· N Ø£Ø¬Ø²Ø§Ø¡.</div>
      </div>
    </div>
    <div class="body">
      <div class="panel" style="margin-bottom:10px">
        <div style="display:grid;grid-template-columns:1fr 120px;gap:10px;align-items:end">
          <div>
            <label class="muted" for="groupName" style="display:block;margin-bottom:6px">Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</label>
            <input id="groupName" class="in" placeholder="Ù…Ø«Ø§Ù„: Ø­Ù„Ù‚Ø© Ø§Ù„Ù‡Ù…Ø©" />
          </div>
          <div>
            <label class="muted" for="groupN" style="display:block;margin-bottom:6px">Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡ (N)</label>
            <input id="groupN" class="in" type="number" min="1" max="30" value="1"/>
          </div>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px">
          <button class="btn" id="createGroupBtn" type="button">Ø¥Ù†Ø´Ø§Ø¡</button>
          <button class="btn btnGhost" id="backToGroups" type="button">Ø±Ø¬ÙˆØ¹ Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§ØªÙŠ</button>
        </div>
        <div id="createdGroupBox" class="panel" style="display:none;margin-top:10px">
          <div style="font-weight:900;margin-bottom:6px">ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© âœ…</div>
          <div class="muted" id="createdGroupMeta"></div>

          <div style="margin-top:10px;font-weight:900">Ø¯Ø¹ÙˆØ© Ø¹Ø¶ÙˆØ§Øª</div>
          <div class="muted" style="margin:6px 0 10px">Ø£ÙŠ Ø¹Ø¶ÙˆØ© Ø¨Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© ØªÙ‚Ø¯Ø± ØªØ¯Ø¹Ùˆ Ø¨Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„. Ø§Ù„Ø¯Ø¹ÙˆØ© ØªØ¸Ù‡Ø± Ù„Ù„Ø¨Ù†Øª Ù„Ù…Ø§ ØªØ¯Ø®Ù„ ÙˆØªØ¶ØºØ· â€œÙ‚Ø¨ÙˆÙ„â€.</div>

          <div style="display:grid;grid-template-columns:1fr 120px;gap:10px;align-items:end">
            <div>
              <label class="muted" for="inviteEmail" style="display:block;margin-bottom:6px">Ø¥ÙŠÙ…ÙŠÙ„ Ø§Ù„Ø¨Ù†Øª</label>
              <input id="inviteEmail" class="in" placeholder="name@gmail.com" />
            </div>
            <button class="btn" id="sendInviteBtn" type="button">Ø¥Ø±Ø³Ø§Ù„</button>
          </div>

          <div style="margin-top:10px">
            <div class="muted" style="margin-bottom:6px">Ø§Ù„Ø¯Ø¹ÙˆØ§Øª Ø§Ù„Ù…Ø±Ø³Ù„Ø©</div>
            <div id="sentInvitesList" class="list"></div>
            <div id="sentInvitesEmpty" class="muted" style="display:none">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯Ø¹ÙˆØ§Øª Ø¨Ø¹Ø¯.</div>
          </div>
        </div>
      </div>

      <div class="panel">
        <div style="font-weight:900;margin-bottom:6px">Ù…Ù„Ø§Ø­Ø¸Ø©</div>
        <div class="muted">Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©: Ø¯Ø§Ø®Ù„ ÙƒÙ„ Ù…Ø¬Ù…ÙˆØ¹Ø© Ù†Ø¶ÙŠÙ ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¨Ù†Ø§Øª + ØµÙØ­Ø© ØªÙØ§ØµÙŠÙ„ ÙƒÙ„ Ø¨Ù†Øª (Ù†ÙØ³ÙØ¨ ÙÙ‚Ø·) + Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡ Ø¨Ø§Ù„Ø¶Ø¨Ø· N.</div>
      </div>
    </div>
  </div>
</section>
  </main>
</div>
</div>

<script>
  window.addEventListener('DOMContentLoaded', ()=>{
    const sideBar = document.getElementById("sideBar");
    const collapseBtn = document.getElementById("collapseBtn");

    const btns = {
      my: document.getElementById("navMy"),
      groups: document.getElementById("navGroups"),
      logout: document.getElementById("navLogout"),
    };
    const views = {
      my: document.getElementById("viewMy"),
      groups: document.getElementById("viewGroups"),
      group: document.getElementById("viewGroup"),
      create: document.getElementById("viewCreate"),
    };

    const m = {
      my: document.getElementById("mNavMy"),
      groups: document.getElementById("mNavGroups"),
      more: document.getElementById("mNavMore"),
    };
    const sheetBackdrop = document.getElementById("sheetBackdrop");
    const bottomSheet = document.getElementById("bottomSheet");
    const sheetLogout = document.getElementById("sheetLogout");

    function isMobile(){ return window.matchMedia("(max-width: 980px)").matches; }

    function closeSheet(){
      sheetBackdrop?.classList.remove("show");
      bottomSheet?.classList.remove("show");
      bottomSheet?.setAttribute("aria-hidden","true");
    }
    function openSheet(){
      sheetBackdrop?.classList.add("show");
      bottomSheet?.classList.add("show");
      bottomSheet?.setAttribute("aria-hidden","false");
    }

    function setActive(which){
      // Force-hide all views (hard reset)
      Object.values(views).forEach(v=>{
        if(!v) return;
        v.classList.remove("show");
        v.style.display = "none";
      });

      // Activate selected view
      const target = views[which];
      if(target){
        target.style.display = "block";
        target.classList.add("show");
      }

      // Desktop nav active
      Object.values(btns).forEach(b=>b && b.classList.remove("active"));
      if(btns[which]) btns[which].classList.add("active");
      if((which==="group" || which==="create") && btns.groups) btns.groups.classList.add("active");

      // Mobile nav active
      Object.values(m).forEach(b=>b && b.classList.remove("active"));
      if(which==="my" && m.my) m.my.classList.add("active");
      if((which==="groups" || which==="group" || which==="create") && m.groups) m.groups.classList.add("active");

      closeSheet();
      localStorage.setItem("activeView", which);

      try{ window.scrollTo({ top: 0, behavior: "smooth" }); }catch(e){ window.scrollTo(0,0); }
    }

    const saved = localStorage.getItem("activeView") || "my";
    setActive(saved);

    // Desktop collapse
    collapseBtn?.addEventListener("click", ()=>{
      const collapsed = sideBar.classList.toggle("collapsed");
      document.body.classList.toggle("sidebarCollapsed", collapsed);
      collapseBtn.textContent = collapsed ? "â¯â¯" : "â®â®";
      localStorage.setItem("sideCollapsed", collapsed ? "1" : "0");
    });
    const c = localStorage.getItem("sideCollapsed")==="1";
    if(c && !isMobile()){
      sideBar.classList.add("collapsed");
      document.body.classList.add("sidebarCollapsed");
      collapseBtn.textContent = "â¯â¯";
    }

    // Desktop nav handlers
    btns.my?.addEventListener("click", ()=>setActive("my"));
    btns.groups?.addEventListener("click", ()=>setActive("groups"));
    btns.logout?.addEventListener("click", ()=>{
      const b = document.getElementById("logoutBtn2") || document.getElementById("logoutBtn");
      b?.click();
    });

    // Mobile bottom nav handlers
    m.my?.addEventListener("click", ()=>setActive("my"));
    m.groups?.addEventListener("click", ()=>setActive("groups"));
    m.more?.addEventListener("click", ()=>openSheet());
    sheetBackdrop?.addEventListener("click", closeSheet);

    sheetLogout?.addEventListener("click", ()=>{
      closeSheet();
      const b = document.getElementById("logoutBtn2") || document.getElementById("logoutBtn");
      b?.click();
    });

    // groups page create button
    document.getElementById("goCreateFromGroups")?.addEventListener("click", ()=>setActive("create"));

    window.__setActiveView = setActive;
    });
</script>

<script type="module">// Never fail silently
window.addEventListener('error', (e)=>{
  try{ showToast(`Ø®Ø·Ø£: ${e?.message || 'unknown'}`); }catch(_){ }
  try{ console.error(e); }catch(_){ }
});
window.addEventListener('unhandledrejection', (e)=>{
  try{ showToast(`Ø®Ø·Ø£: ${e?.reason?.code || e?.reason?.message || 'promise rejected'}`); }catch(_){ }
  try{ console.error(e); }catch(_){ }
});


  const firebaseConfig = {
  "apiKey": "AIzaSyA4Q9sgwE7U0tIAE5obAoU6OIPKd-9_7Dk",
  "authDomain": "safwa3-ad381.firebaseapp.com",
  "projectId": "safwa3-ad381",
  "storageBucket": "safwa3-ad381.firebasestorage.app",
  "messagingSenderId": "380123503518",
  "appId": "1:380123503518:web:c520823283b420d499148f",
  "measurementId": "G-6SZ4HR9BDK"
};
  const PART_RANGES = {"1": {"start": 1, "end": 21}, "2": {"start": 22, "end": 41}, "3": {"start": 42, "end": 61}, "4": {"start": 62, "end": 81}, "5": {"start": 82, "end": 101}, "6": {"start": 102, "end": 121}, "7": {"start": 122, "end": 141}, "8": {"start": 142, "end": 161}, "9": {"start": 162, "end": 181}, "10": {"start": 182, "end": 201}, "11": {"start": 202, "end": 221}, "12": {"start": 222, "end": 241}, "13": {"start": 242, "end": 261}, "14": {"start": 262, "end": 281}, "15": {"start": 282, "end": 301}, "16": {"start": 302, "end": 321}, "17": {"start": 322, "end": 341}, "18": {"start": 342, "end": 361}, "19": {"start": 362, "end": 381}, "20": {"start": 382, "end": 401}, "21": {"start": 402, "end": 421}, "22": {"start": 422, "end": 441}, "23": {"start": 442, "end": 461}, "24": {"start": 462, "end": 481}, "25": {"start": 482, "end": 501}, "26": {"start": 502, "end": 521}, "27": {"start": 522, "end": 541}, "28": {"start": 542, "end": 561}, "29": {"start": 562, "end": 581}, "30": {"start": 582, "end": 604}};

  // Compatibility helper (older code used partRanges(partNum))
  function partRanges(partNum){
    const key = String(partNum);
    if (typeof PART_RANGES !== 'undefined' && PART_RANGES[key]) return PART_RANGES[key];
    const n = Number(partNum);
    if (!n || n < 1) return { start: "-", end: "-" };
    const start = (n - 1) * 20 + 1;
    const end = Math.min(n * 20, 604);
    return { start, end };
  }
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import {getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, GoogleAuthProvider, signInWithPopup, sendPasswordResetEmail , setPersistence , browserLocalPersistence} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {getFirestore, doc, getDoc, setDoc, collection, addDoc, updateDoc, deleteDoc, serverTimestamp, query, where, getDocs, onSnapshot, orderBy , writeBatch} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const el = (id)=>document.getElementById(id);

  const rowsEl = el("rows");
  const authStatusEl = el("authStatus");
  const partsGridEl = el("partsGrid");
  const greetEl = el("greet");
  const globalLastEl = el("globalLast");
  const lastSavedEl = el("lastSaved");

  const toastEl = el("toast");
  const toastTextEl = el("toastText");

  const introOverlay = el("introOverlay");
  const introTitle = el("introTitle");
  const introSub = el("introSub");
  const introBody = el("introBody");
  const dotsEl = el("dots");
  const prevIntroBtn = el("prevIntroBtn");
  const nextIntroBtn = el("nextIntroBtn");

  function fmtDate(iso){
    if(!iso) return "â€”";
    try{ return new Date(iso).toLocaleString("ar"); }catch{ return "â€”"; }
  }

  function showToast(msg){
  if(!toastEl || !toastTextEl) return;
  toastTextEl.textContent = (msg ?? "").toString();
  toastEl.classList.add("show");
  clearTimeout(window.__toastT);
  window.__toastT = setTimeout(()=>toastEl.classList.remove("show"), 2600);
}

  const toast = (title, msg)=> showToast((msg || title || "").toString());

  window.addEventListener('error', (e)=>{ try{ showToast('Ø®Ø·Ø£: ' + (e.message||'')); }catch(_){} });


  function setAuthStatus(msg, kind=""){
    authStatusEl.textContent = msg;
    authStatusEl.className = "status" + (kind ? " "+kind : "");
  }

  function showOnly(which){
    el("authCard").classList.toggle("hide", which !== "auth");
    el("dash").classList.toggle("hide", which !== "dash");
    el("partView").classList.toggle("hide", which !== "part");
  }
// Intro steps (wizard)
  const INTRO_STEPS = [
    { title:"Ø£Ù‡Ù„Ù‹Ø§ ÙÙŠ Ø§Ù„Ø­Ù„Ù‚Ø© ğŸŒ¸", sub:"Ù‡Ø¯ÙÙ†Ø§ Ø­ÙØ¸ Ø«Ø§Ø¨Øª ÙˆÙ…ØªÙŠÙ†ØŒ Ù…Ø´ Ø¨Ø³ â€œÙ†Ø®Ù„Øµ ØµÙØ­Ø§Øªâ€.",
      body:"Ø¹Ø´Ø§Ù† Ù‡ÙŠÙƒ Ù†Ù…Ø´ÙŠ Ø¹Ù„Ù‰ Ù†Ø¸Ø§Ù… Ø¨Ø³ÙŠØ·: <b>Ù„ÙƒÙ„ ØµÙØ­Ø© 3 Ù…Ø±Ø§Ø­Ù„ + ØªØ³Ù…ÙŠØ¹ ÙˆØ§Ø­Ø¯</b> âœ…<br><br><span class='mini'>Ù…Ù„Ø§Ø­Ø¸Ø©: Ù‡Ø°Ø§ Ø§Ù„Ù†Ø¸Ø§Ù… Ù„Ù…ØµØ­Ù Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© (604 ØµÙØ­Ø©).</span>" },
    { title:"Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ â€” ØªÙ„Ø§ÙˆØ© ØºÙŠØ¨Ù‹Ø§ (Ø¨Ø¯ÙˆÙ† Ø£Ø®Ø·Ø§Ø¡)", sub:"Ø¨Ø¹Ø¯ Ù…Ø§ Ù†Ø­ÙØ¸ Ø§Ù„ØµÙØ­Ø©:",
      body:"â€¢ Ù†Ù‚Ø±Ø£Ù‡Ø§ <b>10 Ù…Ø±Ø§Øª ØºÙŠØ¨Ù‹Ø§</b> Ø¨Ø¯ÙˆÙ† Ø£Ø®Ø·Ø§Ø¡.<br>â€¢ ÙƒÙ„ Ù…Ø±Ø© ØµØ­ÙŠØ­Ø© Ù†Ù„ÙˆÙ‘Ù† Ø¯Ø§Ø¦Ø±Ø© Ù…Ù† <b>ØªÙ„Ø§ÙˆØ© ØºÙŠØ¨Ù‹Ø§</b>.<br><br><span class='mini'>Ø¥Ø°Ø§ ØµØ§Ø± Ø®Ø·Ø£ ÙƒØ¨ÙŠØ±: Ù†Ø«Ø¨Ù‘Øª ÙˆÙ†ÙƒÙ…Ù„ Ù„Ø­Ø¯ Ù…Ø§ ØªØµÙŠØ± Ø§Ù„ØªÙ„Ø§ÙˆØ© Ø³Ù„ÙŠÙ…Ø©.</span>" },
    { title:"Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ© â€” Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù‚Ø±ÙŠØ¨Ø© (Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø£ÙˆÙ„)", sub:"Ø®Ù„Ø§Ù„ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø£ÙˆÙ„ Ø¨Ø¹Ø¯ Ø­ÙØ¸ Ø§Ù„ØµÙØ­Ø©:",
      body:"â€¢ Ù†Ø±Ø§Ø¬Ø¹ Ø§Ù„ØµÙØ­Ø© Ø¹Ø¯Ø© Ù…Ø±Ø§Øª (Ø­Ø³Ø¨ Ø·Ø§Ù‚ØªÙ†Ø§).<br>â€¢ Ù„ÙƒÙ„ Ù…Ø±Ø§Ø¬Ø¹Ø© Ù†Ù„ÙˆÙ‘Ù† Ø¯Ø§Ø¦Ø±Ø© Ù…Ù† <b>Ù…Ø±Ø§Ø¬Ø¹Ø© Ù‚Ø±ÙŠØ¨Ø©</b>." },
    { title:"Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø«Ø§Ù„Ø«Ø© â€” Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¨Ø¹ÙŠØ¯Ø© (Ø®Ù„Ø§Ù„ Ø§Ù„Ø´Ù‡Ø±)", sub:"Ø®Ù„Ø§Ù„ Ø§Ù„Ø´Ù‡Ø± Ø¨Ø¹Ø¯ ",
      body:"â€¢ Ù†Ø±Ø§Ø¬Ø¹ Ø§Ù„ØµÙØ­Ø© Ø¹Ø¯Ø© Ù…Ø±Ø§Øª Ù…ØªÙØ±Ù‘Ù‚Ø©.<br>â€¢ Ù„ÙƒÙ„ Ù…Ø±Ø§Ø¬Ø¹Ø© Ù†Ù„ÙˆÙ‘Ù† Ø¯Ø§Ø¦Ø±Ø© Ù…Ù† <b>Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¨Ø¹ÙŠØ¯Ø©</b>." },
    { title:"Ø§Ù„ØªØ³Ù…ÙŠØ¹ â€” Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©", sub:"Ø§Ù„ØªØ³Ù…ÙŠØ¹ Ù…Ù…ÙƒÙ† Ù‚Ø¨Ù„ Ø£Ùˆ Ø¨Ø¹Ø¯ (Ù…Ø§ ÙÙŠ Ù…Ø´ÙƒÙ„Ø©).",
      body:"Ø¨Ø¹Ø¯ Ù…Ø§ Ø§Ù„ØµÙØ­Ø© ØªÙƒÙˆÙ† Ø¬Ø§Ù‡Ø²Ø©: Ù†Ø³Ù…Ù‘Ø¹Ù‡Ø§ ØºÙŠØ¨Ù‹Ø§ (Ø¹Ù„Ù‰ ØµØ§Ø­Ø¨Ø©/Ù…ÙØ³ÙÙ…Ù‘ÙØ¹Ø©).<br>Ù„Ù…Ø§ ÙŠØªÙ… Ø§Ù„ØªØ³Ù…ÙŠØ¹ Ø¨Ù†Ø¬Ø§Ø­ Ù†Ø¹Ù„Ù‘Ù… Ù…Ø±Ø¨Ø¹ <b>ØªØ³Ù…ÙŠØ¹</b>.<br><br><b>Ø§Ù„ØªØ³Ù…ÙŠØ¹ Ù„Ù„ØµÙØ­Ø© ÙŠÙƒÙˆÙ† Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·.</b>" },
    { title:"Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø¬Ø²Ø¡ âœ…ğŸŒ™", sub:"Ø­ØªÙ‰ Ù†Ø¹ØªØ¨Ø± Ø§Ù„Ø¬Ø²Ø¡ Ù…ÙƒØªÙ…Ù„:",
      body:"Ù„Ø§Ø²Ù… Ù†Ø¹Ù…Ù„ Ø®Ø·ÙˆØªÙŠÙ†:<br>1) âœ… <b>ØªØ³Ù…ÙŠØ¹ Ø§Ù„Ø¬Ø²Ø¡ ØºÙŠØ¨Ù‹Ø§</b><br>2) âœ… <b>Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…ÙˆØ§Ø¶Ø¹ (Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¬Ø²Ø¡)</b><br><br><span class='mini'>â€œÙ…ÙƒØªÙ…Ù„ âœ…â€ Ù„Ù„Ø¬Ø²Ø¡ Ù„Ø§ ÙŠØ¸Ù‡Ø± Ø¥Ù„Ø§ Ø¨Ø¹Ø¯ Ø¥ØªÙ…Ø§Ù… Ø§Ù„ØªØ³Ù…ÙŠØ¹ + Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±.</span>" }
  ];
  let introIdx = 0;

  function renderIntro(){
    const s = INTRO_STEPS[introIdx];
    introTitle.textContent = s.title;
    introSub.textContent = s.sub;
    introBody.innerHTML = s.body;

    dotsEl.innerHTML = "";
    INTRO_STEPS.forEach((_,i)=>{
      const d = document.createElement("div");
      d.className = "dot" + (i===introIdx ? " on" : "");
      dotsEl.appendChild(d);
    });

    prevIntroBtn.style.visibility = introIdx===0 ? "hidden" : "visible";
    nextIntroBtn.textContent = introIdx===INTRO_STEPS.length-1 ? "Ø§Ø¨Ø¯Ø¦ÙŠ Ø§Ù„Ø¢Ù†" : "Ø§Ù„ØªØ§Ù„ÙŠ";
  }

  function openIntro(){ introIdx=0; renderIntro(); introOverlay.classList.remove("hide"); }
  function closeIntro(){ introOverlay.classList.add("hide"); }

  prevIntroBtn.addEventListener("click", ()=>{ if(introIdx>0){ introIdx--; renderIntro(); }});
  nextIntroBtn.addEventListener("click", async ()=>{
    if(introIdx < INTRO_STEPS.length-1){ introIdx++; renderIntro(); return; }
    closeIntro(); await markIntroSeen();
  });
  el("closeIntroBtn").addEventListener("click", async ()=>{ closeIntro(); await markIntroSeen(); });

  // email panel toggle
  el("showEmailBtn").addEventListener("click", ()=>{ el("emailPanel").style.display="block"; });
  el("hideEmailBtn").addEventListener("click", ()=>{ el("emailPanel").style.display="none"; });

  // circles builders
  function makeCircles(n, cols, stateArr){
    const wrap = document.createElement("div");
    wrap.className = "circles " + (cols===5 ? "grid5" : cols===3 ? "grid3" : "grid2");
    for(let i=0;i<n;i++){
      const c = document.createElement("div");
      c.className = "c" + (stateArr?.[i] ? " on" : "");
      c.addEventListener("click", ()=>{
        c.classList.toggle("on");
        scheduleAutosave();
      });
      wrap.appendChild(c);
    }
    return wrap;
  }
  function readCircles(container){
    return [...container.querySelectorAll(".c")].map(x=>x.classList.contains("on"));
  }

  // ---- Compatibility layer (keeps old saved data visible) ----
  function toBoolArray(v, n){
    if(Array.isArray(v)){
      // normalize to booleans, pad/truncate
      const out = v.map(Boolean).slice(0,n);
      while(out.length<n) out.push(false);
      return out;
    }
    if(typeof v === "number"){
      // treat number as count of completed circles
      const out = Array(n).fill(false);
      for(let i=0;i<Math.min(n, v);i++) out[i]=true;
      return out;
    }
    return Array(n).fill(false);
  }

  function normalizePage(raw){
    const pg = raw && typeof raw === "object" ? raw : {};
    // recite (10)
    const recite = pg.recite ?? pg.tilawa ?? pg.mem ?? pg.newMem ?? pg.hifz ?? pg.ghiban ?? pg.talaawa;
    // near (6)
    const near = pg.near ?? pg.close ?? pg.closeReview ?? pg.nearReview ?? pg.week ?? pg.week1 ?? pg.qareeba ?? pg.reviewClose;
    // far (4)
    const far = pg.far ?? pg.farReview ?? pg.month ?? pg.ba3eeda ?? pg.reviewFar ?? pg.longReview;
    // tasmee3 bool
    const tas = pg.tasmee3 ?? pg.tasme3 ?? pg.tasmee ?? pg.tasmee3Done ?? pg.tasmee3Checked ?? pg.tasmeeDone ?? false;

    return {
      recite: toBoolArray(recite, 10),
      near: toBoolArray(near, 6),
      far: toBoolArray(far, 4),
      tasmee3: !!tas,
      notes: (pg.notes ?? pg.note ?? pg.comment ?? "").toString()
    };
  }
  // ------------------------------------------------------------

  function rowForPage(pageNum, dataRaw={}){
    const data = normalizePage(dataRaw);

    const tr = document.createElement("tr");
    tr.dataset.page = String(pageNum);

    const tdPage = document.createElement("td"); tdPage.textContent = String(pageNum);

    const tdRecite = document.createElement("td");
    tdRecite.appendChild(makeCircles(10, 5, data.recite));

    const tdNear = document.createElement("td");
    tdNear.appendChild(makeCircles(6, 3, data.near));

    const tdFar = document.createElement("td");
    tdFar.appendChild(makeCircles(4, 2, data.far));

    const tdTas = document.createElement("td");
    const tasWrap = document.createElement("div");
    tasWrap.style.display = "flex";
    tasWrap.style.justifyContent = "center";
    const chk = document.createElement("input");
    chk.type = "checkbox";
    chk.className = "tasmee3Box";
    chk.checked = !!data.tasmee3;
    chk.addEventListener("change", scheduleAutosave);
    tasWrap.appendChild(chk);
    tdTas.appendChild(tasWrap);

    const tdNotes = document.createElement("td");
    const notesWrap = document.createElement("div");
    notesWrap.style.display = "flex";
    notesWrap.style.justifyContent = "center";
    const inpNotes = document.createElement("input");
    inpNotes.placeholder = "Ø§Ø®ØªÙŠØ§Ø±ÙŠ";
    inpNotes.style.maxWidth = "210px";
    inpNotes.style.width = "100%";
    inpNotes.style.textAlign = "center";
    inpNotes.value = data.notes ?? "";
    inpNotes.addEventListener("input", scheduleAutosave);
    notesWrap.appendChild(inpNotes);
    tdNotes.appendChild(notesWrap);

    tr.append(tdPage, tdRecite, tdNear, tdFar, tdTas, tdNotes);
    rowsEl.appendChild(tr);
  }

  function pagesForPart(partNum){
    const r = PART_RANGES[String(partNum)];
    const out = [];
    for(let p=r.start; p<=r.end; p++) out.push(p);
    return out;
  }

  function collectPart(partNum){
    const pages = {};
    [...rowsEl.querySelectorAll("tr")].forEach(tr=>{
      const page = tr.dataset.page;
      const circles = tr.querySelectorAll(".circles");
      const tas = tr.querySelector("input.tasmee3Box")?.checked || false;
      const notes = tr.querySelector("td:last-child input")?.value?.trim() || "";
      pages[page] = {
        recite: readCircles(circles[0]),
        near: readCircles(circles[1]),
        far: readCircles(circles[2]),
        tasmee3: tas,
        notes
      };
    });
    return {
      details: el("details").value.trim(),
      partTasmee3: el("partTasmee3").checked,
      partTest: el("partTest").checked,
      pages,
      updatedAt: new Date().toISOString()
    };
  }

  function loadPartToUI(partNum, userDoc){
    el("partTitle").textContent = "Ø§Ù„Ø¬Ø²Ø¡ " + partNum;
    const r = PART_RANGES[String(partNum)];
    el("partSubtitle").textContent = `ØµÙØ­Ø§Øª: ${r.start}â€“${r.end} (Ù…ØµØ­Ù Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©)`;

    const part = userDoc.parts?.[String(partNum)] ?? {};
    el("details").value = (part.details ?? part.note ?? "").toString();
    el("partTasmee3").checked = !!(part.partTasmee3 ?? part.juzTasmee3 ?? false);
    el("partTest").checked = !!(part.partTest ?? part.juzTest ?? part.mawaqi3Test ?? false);

    lastSavedEl.textContent = "Ø¢Ø®Ø± ØªØ¹Ø¯ÙŠÙ„: " + fmtDate(part.updatedAt);

    rowsEl.innerHTML = "";
    const pagesList = pagesForPart(partNum);
    const savedPages = part.pages ?? part.pageData ?? {};
    pagesList.forEach(p=> rowForPage(p, savedPages[String(p)] || {}));

    el("details").addEventListener("input", scheduleAutosave);
    el("partTasmee3").addEventListener("change", scheduleAutosave);
    el("partTest").addEventListener("change", scheduleAutosave);
  }

  function calcPartProgress(partRaw, partNum){
    const part = partRaw || {};
    const r = PART_RANGES[String(partNum)];
    const totalPages = (r.end - r.start + 1);

    const pagesObj = part.pages ?? part.pageData ?? {};

    //  Ù†Ø³Ø¨Ø© Ø§Ù„ØµÙØ­Ø§Øª Ø§Ù„ØªÙŠ ØªÙ… ØªØ³Ù…ÙŠØ¹Ù‡Ø§ (checkbox ÙÙŠ Ø¹Ù…ÙˆØ¯ ØªØ³Ù…ÙŠØ¹ Ø§Ù„ØµÙØ­Ø§Øª)
    let memDone = 0;
    for(let p=r.start; p<=r.end; p++){
      const raw = pagesObj[String(p)] || {};
      const pg = normalizePage(raw);
      if(pg.tasmee3) memDone++;
    }
    const Ø­ÙØ¸Pct = totalPages ? Math.round((memDone/totalPages)*100) : 0;

    // ØªØ«Ø¨ÙŠØª: Ù†Ø³Ø¨Ø© Ø§Ù„Ø¯ÙˆØ§Ø¦Ø±/Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ù„ÙƒÙ„ Ø§Ù„ØµÙØ­Ø§Øª (Ø­ØªÙ‰ Ù„Ùˆ ØµÙØ­Ø§Øª ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„Ø¯Ø§ØªØ§)
    const perPageTotal = 10 + 6 + 4 + 1; // recite + near + far + tasmee3
    const total = totalPages * perPageTotal;
    let on = 0;
    for(let p=r.start; p<=r.end; p++){
      const raw = pagesObj[String(p)] || {};
      const pg = normalizePage(raw);
      on += pg.recite.filter(Boolean).length;
      on += pg.near.filter(Boolean).length;
      on += pg.far.filter(Boolean).length;
      on += pg.tasmee3 ? 1 : 0;
    }
    const ØªØ«Ø¨ÙŠØªPct = total ? Math.round((on/total)*100) : 0;

    const started = (on > 0);
    const done = (Ø­ÙØ¸Pct === 100) && !!(part.partTasmee3 ?? part.juzTasmee3) && !!(part.partTest ?? part.juzTest ?? part.mawaqi3Test);
    return {started, done, Ø­ÙØ¸Pct, ØªØ«Ø¨ÙŠØªPct};
  }

  // ===== Color state mapping for parts (v24_40) =====
function __applyPartStateClass(btn, pr){
  const mem = Number(pr?.Ø­ÙØ¸Pct ?? 0) || 0;
  const fix = Number(pr?.ØªØ«Ø¨ÙŠØªPct ?? 0) || 0;

  // reset
  btn.classList.remove("partInProgress","partMemDone","partFixDone");

  // logic:
  // green: mem==100 and fix==100
  if (mem >= 100 && fix >= 100){
    btn.classList.add("partFixDone");
    return;
  }
  // orange: mem==100 and fix<100
  if (mem >= 100){
    btn.classList.add("partMemDone");
    return;
  }
  // pink: started but not completed (either mem>0 or fix>0)
  if (mem > 0 || fix > 0){
    btn.classList.add("partInProgress");
    return;
  }
  // default: leave as-is (not started)
}

function buildPartsGrid(userDoc){
    partsGridEl.innerHTML = "";
    for(let p=1;p<=30;p++){
      const btn = document.createElement("button");
      btn.type="button";
      btn.className="partBtn";
      const part = userDoc.parts?.[String(p)];
      const pr = calcPartProgress(part, p);

      
      __applyPartStateClass(btn, pr);
const r = PART_RANGES[String(p)];

      let tagText = "";
      if(pr.done){
        tagText = `Ù…ÙƒØªÙ…Ù„ âœ…<br>ØªØ«Ø¨ÙŠØª: ${pr.ØªØ«Ø¨ÙŠØªPct}%`;
      }
    else{
        tagText = ` ${pr.Ø­ÙØ¸Pct}%<br>ØªØ«Ø¨ÙŠØª: ${pr.ØªØ«Ø¨ÙŠØªPct}%`;
      }

      btn.innerHTML = `<div class="partNum">Ø§Ù„Ø¬Ø²Ø¡ ${p}</div>
                       <div class="partMeta">ØµÙØ­Ø§Øª ${r.start}â€“${r.end}</div>
                       <div class="tag">${tagText}</div>`;
      btn.addEventListener("click", ()=> openPart(p));
      partsGridEl.appendChild(btn);
    }
  }

  function friendlyAuthError(code){
    const map = {
      "auth/invalid-email":"Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ ØºÙŠØ± ØµØ­ÙŠØ­.",
      "auth/user-not-found":"Ù…Ø§ ÙÙŠ Ø­Ø³Ø§Ø¨ Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„. Ø¬Ø±Ù‘Ø¨ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨.",
      "auth/wrong-password":"ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.",
      "auth/email-already-in-use":"Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¨Ù‚Ù‹Ø§. Ø¬Ø±Ù‘Ø¨ÙŠ Ø¯Ø®ÙˆÙ„.",
      "auth/weak-password":"ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¶Ø¹ÙŠÙØ© (6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„).",
      "auth/popup-closed-by-user":"ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Google Ù‚Ø¨Ù„ Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø¯Ø®ÙˆÙ„.",
      "auth/operation-not-allowed":"ÙØ¹Ù‘Ù„ÙŠ Google Ùˆ Email/Password Ù…Ù† Firebase Authentication.",
    };
    return map[code] || "Ø­ØµÙ„ Ø®Ø·Ø£. Ø¬Ø±Ù‘Ø¨ÙŠ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.";
  }

  // Firebase init
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
// Persist login across refresh
setPersistence(auth, browserLocalPersistence).catch((e)=>{ console.error('persistence error', e); });
  const db = getFirestore(app);

// ===== Groups (v1) =====
const invitesListEl = el("invitesList");
const invitesEmptyEl = el("invitesEmpty");
const myGroupsListEl = el("myGroupsList");
const myGroupsEmptyEl = el("myGroupsEmpty");

const groupNameEl = el("groupName");
const groupNEl = el("groupN");
const createGroupBtn = el("createGroupBtn");
const backToGroupsBtn = el("backToGroups");
const createdGroupBoxEl = el("createdGroupBox");
const createdGroupMetaEl = el("createdGroupMeta");
const inviteEmailEl = el("inviteEmail");
const sendInviteBtn = el("sendInviteBtn");
const sentInvitesListEl = el("sentInvitesList");
const sentInvitesEmptyEl = el("sentInvitesEmpty");

// Live invite listeners (avoid duplicated rendering / keep sender+receiver in sync)
let __invitesUnsub1 = null;
let __invitesUnsub2 = null;
let __sentInvitesUnsub = null;
let __groupInvitesUnsub = null;
let __renderInvitesTimer = null;

function stopInviteListeners(){
  try{ __invitesUnsub1 && __invitesUnsub1(); }catch(e){}
  try{ __invitesUnsub2 && __invitesUnsub2(); }catch(e){}
  try{ __sentInvitesUnsub && __sentInvitesUnsub(); }catch(e){}
  try{ __groupInvitesUnsub && __groupInvitesUnsub(); }catch(e){}
  __invitesUnsub1 = __invitesUnsub2 = __sentInvitesUnsub = __groupInvitesUnsub = null;
}

function __scheduleRenderInvites(renderFn){
  // Small debounce because we may merge two snapshots (back-compat queries)
  if(__renderInvitesTimer) clearTimeout(__renderInvitesTimer);
  __renderInvitesTimer = setTimeout(renderFn, 30);
}

// Group page
const groupTitleEl = el("groupTitle");
const groupSubEl = el("groupSub");
const backToGroupsFromGroupBtn = el("backToGroupsFromGroup");
const refreshGroupBtn = el("refreshGroup");

const pickPartsPanelEl = el("pickPartsPanel");
const myPartsSummaryTextEl = el("myPartsSummaryText");
const editMyPartsBtn = el("editMyPartsBtn");

// parts modal elements
const partsOverlayEl = el("partsOverlay");
const partsPickerGridModalEl = el("partsPickerGridModal");
const partsPickerCountModalEl = el("partsPickerCountModal");
const partsModalHintEl = el("partsModalHint");
const partsModalCloseBtn = el("partsModalClose");
const partsModalCancelBtn = el("partsModalCancel");
const partsModalSaveBtn = el("partsModalSave");

// member parts overlay
const memberPartsOverlayEl = el("memberPartsOverlay");
const memberPartsTitleEl = el("memberPartsTitle");
const memberPartsSubtitleEl = el("memberPartsSubtitle");
const memberPartsBodyEl = el("memberPartsBody");
const memberPartsCloseBtn = el("memberPartsClose");
const memberPartsOkBtn = el("memberPartsOk");

const pickPartsHintEl = el("pickPartsHint");
const partsPickerGridEl = el("partsPickerGrid");
const partsPickerCountEl = el("partsPickerCount");
const savePickedPartsBtn = el("savePickedParts");

const groupInviteEmailEl = el("groupInviteEmail");
const groupSendInviteBtn = el("groupSendInvite");
const groupInvitesListEl = el("groupInvitesList");
const groupInvitesEmptyEl = el("groupInvitesEmpty");

const groupMembersListEl = el("groupMembersList");
const groupMembersEmptyEl = el("groupMembersEmpty");

let activeGroupId = null;
let activeGroupGoalN = null;
let activeGroupName = null;
let pickedParts = [];
const refreshGroupsBtn = el("refreshGroups");

// realtime listener for members
let membersUnsub = null;

let currentUser = null;
      window.currentUser = null;
let pendingGroupsLoad = false; // if user clicks Groups before auth is ready

let currentUserEmail = null;
let createdGroupId = null;
const normEmail = (e)=> (e||"").trim().toLowerCase();
const inviteDocId = (groupId, emailLower)=> `${groupId}__${encodeURIComponent(emailLower)}`;

const fmtTime = (ts)=>{
  try{
    const d = ts?.toDate ? ts.toDate() : (ts instanceof Date ? ts : null);
    if(!d) return "";
    return d.toLocaleString("ar", { hour12:true });
  }catch(e){ return ""; }
};

function itemRow({title, sub, right}){
  const wrap = document.createElement("div");
  wrap.className = "item";
  const meta = document.createElement("div");
  meta.className = "meta";
  const t = document.createElement("div");
  t.className = "title";
  t.textContent = title;
  const s = document.createElement("div");
  s.className = "sub";
  s.textContent = sub || "";
  meta.appendChild(t); meta.appendChild(s);
  const actions = document.createElement("div");
  actions.className = "actions";
  if(right) actions.appendChild(right);
  wrap.appendChild(meta);
  wrap.appendChild(actions);
  return wrap;
}

function makeProgressRing(pct){
  const ring = document.createElement("div");
  ring.className = "progRing";
  const val = (pct===null || pct===undefined || Number.isNaN(Number(pct))) ? null : Math.max(0, Math.min(100, Math.round(Number(pct))));
  if(val === null){
    ring.classList.add("empty");
    ring.style.setProperty("--p", 0);
    ring.innerHTML = "<span>â€”</span>";
    ring.title = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù„Ø®Ù‘Øµ Ø­ÙØ¸ Ø¨Ø¹Ø¯";
  }else{
    ring.style.setProperty("--p", val);
    ring.innerHTML = `<span>${val}%</span>`;
    ring.title = `Ù†Ø³Ø¨Ø©  ${val}%`;
  }
  return ring;
}


let _loadMyGroupsRunId = 0;

async function loadMyGroups(){
  const runId = ++_loadMyGroupsRunId;
  if(!currentUser){
    myGroupsListEl.innerHTML = "";
    myGroupsEmptyEl.style.display = "block";
    return;
  }
  myGroupsListEl.innerHTML = "";
  myGroupsEmptyEl.style.display = "none";

  let groups = [];
  try{
    const snap = await getDocs(collection(db, "userGroups", currentUser.uid, "groups"));
    console.log("[myGroups] uid:", currentUser.uid, "userGroups count:", snap.size);
    if(snap.size===0){ toast("ØªÙ†Ø¨ÙŠÙ‡", "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© ØªØ­Øª Ø­Ø³Ø§Ø¨Ùƒ Ø¨Ø¹Ø¯ Ø§Ù„Ø±ÙŠÙØ±ÙŠØ´. ØªØ£ÙƒØ¯ÙŠ Ø£Ù† Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Firestore ØªØ­Øª userGroups/UID/groups."); }

    snap.forEach(d=>{ console.log("[myGroups] doc", d.id, d.data()); groups.push({ id: d.id, ...d.data() }); });
  }catch(e){
    console.error(e);
    toast("Ø®Ø·Ø£", e?.code ? `ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ù…Ø¬Ù…ÙˆØ¹Ø§ØªÙŠ: ${e.code}` : "ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ù…Ø¬Ù…ÙˆØ¹Ø§ØªÙŠ.");
  }

  // Fallback: groups I created (Ø­ØªÙ‰ Ù„Ùˆ userGroups Ù…Ø§ Ø±Ø¬Ø¹Øª Ù„Ø£ÙŠ Ø³Ø¨Ø¨)
  if(groups.length === 0){
    try{
      const qOwn = query(collection(db, "groups"), where("createdByUid","==", currentUser.uid));
      const snap2 = await getDocs(qOwn);
      snap2.forEach(d=>{
        const g = d.data() || {};
        groups.push({
          id: d.id,
          groupId: d.id,
          name: g.name,
          goalType: g.goalType,
          goalN: g.goalN,
          joinedAt: g.createdAt
        });
      });
    }catch(e){
      console.error(e);
    }
  }

  if(groups.length === 0){
    if(runId !== _loadMyGroupsRunId) return;
    myGroupsEmptyEl.style.display = "block";
    return;
  }

  if(runId !== _loadMyGroupsRunId) return;
  myGroupsListEl.innerHTML = "";
  myGroupsEmptyEl.style.display = "none";

  // Sort newest first by joinedAt/createdAt
  groups.sort((a,b)=>{
    const ta = a.joinedAt?.seconds || 0;
    const tb = b.joinedAt?.seconds || 0;
    return tb - ta;
  });

  groups.forEach(g=>{
    const btn = document.createElement("button");
    btn.className = "miniBtn";
    btn.textContent = "ÙØªØ­";
    const gid = g.groupId || g.id;
    btn.onclick = ()=>openGroupPage(gid);
    const row = itemRow({
      title: g.name || "Ù…Ø¬Ù…ÙˆØ¹Ø©",
      sub: `Ø§Ù„Ù‡Ø¯Ù: ${g.goalN || "?"} Ø£Ø¬Ø²Ø§Ø¡`,
      right: btn
    });
    myGroupsListEl.appendChild(row);
  });
}

function openGroupsTab(){ setDashView("groups"); }


async function openGroupPage(groupId){
  activeGroupId = groupId;
  localStorage.setItem("activeGroupId", groupId);
  __setActiveView("group");
  await loadGroupPage();
}

function renderPartsPickerInto(gridEl, countEl){
  if(!gridEl) return;
  gridEl.innerHTML = "";
  const total = 30;
  for(let p=1; p<=total; p++){
    const b = document.createElement("button");
    b.type = "button";
    b.className = "partBtn" + (pickedParts.includes(p) ? " active" : "");
    b.textContent = String(p);
    b.onclick = ()=>{
      if(pickedParts.includes(p)){
        pickedParts = pickedParts.filter(x=>x!==p);
      }else{
        if(activeGroupGoalN && pickedParts.length >= activeGroupGoalN){
          toast("ØªÙ†Ø¨ÙŠÙ‡", `Ø§Ø®ØªØ§Ø±ÙŠ Ø¨Ø§Ù„Ø¶Ø¨Ø· ${activeGroupGoalN} Ø£Ø¬Ø²Ø§Ø¡ ÙÙ‚Ø·.`);
          return;
        }
        pickedParts = [...pickedParts, p].sort((a,b)=>a-b);
      }
      renderPartsPickerInto(gridEl, countEl);
      updatePartsPickerCountInto(countEl);
    };
    gridEl.appendChild(b);
  }
}

function renderPartsPicker(){
  // legacy (hidden panel) - keep for compatibility
  renderPartsPickerInto(partsPickerGridEl, partsPickerCountEl);
}

function updatePartsPickerCountInto(countEl){
  const n = activeGroupGoalN || 0;
  if(countEl) countEl.textContent = `${pickedParts.length} / ${n}`;
}

function updatePartsPickerCount(){
  updatePartsPickerCountInto(partsPickerCountEl);
}

async function loadGroupInvites(){
  // Live list of *pending* invites for this group (sender view).
  // When the invite is accepted/declined, it disappears automatically.
  groupInvitesListEl.innerHTML = "";
  groupInvitesEmptyEl.style.display = "none";

  if(!activeGroupId) return;

  try{ __groupInvitesUnsub && __groupInvitesUnsub(); }catch(e){}
  __groupInvitesUnsub = null;

  const qInv = query(
    collection(db, "groupInvites"),
    where("groupId","==", activeGroupId),
    where("status","==","pending")
  );

  __groupInvitesUnsub = onSnapshot(qInv, (snap)=>{
    groupInvitesListEl.innerHTML = "";
    groupInvitesEmptyEl.style.display = "none";

    if(snap.empty){
      groupInvitesEmptyEl.textContent = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯Ø¹ÙˆØ§Øª Ù…Ø¹Ù„Ù‘Ù‚Ø©.";
      groupInvitesEmptyEl.style.display = "block";
      return;
    }

    const rows = [];
    snap.forEach(d=>{
      const inv = d.data() || {};
      const t = inv?.createdAt?.seconds ? inv.createdAt.seconds : 0;
      rows.push({ id: d.id, inv, t });
    });
    rows.sort((a,b)=> b.t - a.t);

    // Safety: avoid rendering duplicates even if the callback fires multiple times (cache/server).
    const seen = new Set();
    rows.forEach(({id, inv})=>{
      if(seen.has(id)) return;
      seen.add(id);

      const row = itemRow({
        title: inv.invitedEmail,
        sub: `Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù‚Ø¨ÙˆÙ„ â€¢ ${fmtTime(inv.createdAt)}`,
        right: null
      });
      row.dataset.inviteId = id;
      groupInvitesListEl.appendChild(row);
    });
  }, (e)=>{ console.error("groupInvites listener error", e); });
}


async function sendGroupInvite(){
  const emailRaw = (groupInviteEmailEl.value || "").trim();
  const emailLower = normEmail(emailRaw);
  if(!emailLower || !emailLower.includes("@")){ toast("ØªÙ†Ø¨ÙŠÙ‡","Ø§ÙƒØªØ¨ÙŠ Ø¥ÙŠÙ…ÙŠÙ„ ØµØ­ÙŠØ­."); return; }
  if(!activeGroupId){ toast("ØªÙ†Ø¨ÙŠÙ‡","Ù„Ø§ ÙŠÙˆØ¬Ø¯ GroupId."); return; }

  groupSendInviteBtn.disabled = true;
  try{
    const invId = inviteDocId(activeGroupId, emailLower);
    const invRef = doc(db, "groupInvites", invId);
    const invSnap = await getDoc(invRef);

    if(invSnap.exists()){
      const prev = invSnap.data() || {};
      if(prev.status === "pending"){ toast("ØªÙ†Ø¨ÙŠÙ‡","Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø¹ÙˆØ© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„ (Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù‚Ø¨ÙˆÙ„)."); return; }
      if(prev.status === "accepted"){ toast("ØªÙ†Ø¨ÙŠÙ‡","ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø¯Ø¹ÙˆØ© Ø³Ø§Ø¨Ù‚Ù‹Ø§."); return; }
    }

    await setDoc(invRef, {
      groupId: activeGroupId,
      groupName: activeGroupName || "Ù…Ø¬Ù…ÙˆØ¹Ø©",
      invitedEmail: emailLower,
      invitedEmailLower: emailLower,
      invitedByUid: currentUser.uid,
      invitedByEmail: currentUserEmail,
      status: "pending",
      createdAt: serverTimestamp(),
      resentAt: invSnap.exists() ? serverTimestamp() : null
    }, { merge:true });

    groupInviteEmailEl.value = "";
    toast("ØªÙ…","ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¯Ø¹ÙˆØ© âœ…");
    await loadGroupInvites();
  }catch(e){
    console.error(e);
    toast("Ø®Ø·Ø£", e?.code ? `ØªØ¹Ø°Ø± Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¯Ø¹ÙˆØ©: ${e.code}` : "ØªØ¹Ø°Ø± Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¯Ø¹ÙˆØ©.");
  }finally{
    groupSendInviteBtn.disabled = false;
  }
}

function listenToGroupMembers(groupId){
  // Stop previous listener (if any)
  try{ if(membersUnsub) membersUnsub(); }catch(e){}
  membersUnsub = null;

  groupMembersListEl.innerHTML = "";
  groupMembersEmptyEl.style.display = "none";

  if(!groupId){
    groupMembersEmptyEl.style.display = "block";
    groupMembersEmptyEl.textContent = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø¹Ø¶Ø§Ø¡ Ø¨Ø¹Ø¯.";
    return;
  }

  const qMem = query(collection(db, "groups", groupId, "members"), orderBy("joinedAt","asc"));
  membersUnsub = onSnapshot(qMem, (snap)=>{
    groupMembersListEl.innerHTML = "";
    groupMembersEmptyEl.style.display = "none";

    if(snap.empty){
      groupMembersEmptyEl.style.display = "block";
      return;
    }

    
const members=[];
    snap.forEach(d=>{
      const m=d.data()||{};
      const ps = m.progressSummary || null;
      const memPct = (ps && typeof ps.avgMem !== "undefined") ? Number(ps.avgMem) : null;
      const fixPct = (ps && typeof ps.avgFix !== "undefined") ? Number(ps.avgFix) : null;

      members.push({
        uid:d.id,
        name:(m.displayName||"").trim() || (m.email? m.email.split("@")[0] : "Ø¹Ø¶ÙˆØ©"),
        parts: Array.isArray(m.selectedParts)? m.selectedParts : [],
        memPct: (Number.isFinite(memPct) ? memPct : null),
        fixPct: (Number.isFinite(fixPct) ? fixPct : null)
      });
    });

    // Sort by memorization progress (avgMem) descending, then by name
    members.sort((a,b)=>{
      const ap = (a.memPct===null ? -1 : a.memPct);
      const bp = (b.memPct===null ? -1 : b.memPct);
      if(bp !== ap) return bp - ap;
      return a.name.localeCompare(b.name,"ar");
    });

    members.forEach((m, idx) => {
      let subTxt = m.parts.length ? `Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡: ${m.parts.join("ØŒ ")}` : "Ù„Ù… ØªØ®ØªÙØ± Ø£Ø¬Ø²Ø§Ø¡ Ø¨Ø¹Ø¯";
      if(m.fixPct !== null && m.fixPct !== undefined){
        subTxt += ` â€¢ ØªØ«Ø¨ÙŠØª: ${m.fixPct}%`;
      }
      const ring = makeProgressRing(m.memPct);
      const row = itemRow({ title: m.name + (m.uid===currentUser?.uid ? " (Ø£Ù†ØªÙ)" : ""), sub: subTxt, right: ring });

const titleEl = row.querySelector(".title");
if(titleEl){
  titleEl.classList.add("titleFlex");
  const rb = document.createElement("div");
  rb.className = "rankBadge";
  rb.textContent = String(idx + 1);
  titleEl.prepend(rb);
}
      row.style.cursor = "pointer";
      row.addEventListener("click", ()=>{
        showMemberParts(m.name + (m.uid===currentUser?.uid ? " (Ø£Ù†ØªÙ)" : ""), m.parts, m.uid);
      });
      groupMembersListEl.appendChild(row);
    });
  }, (err)=>{
    console.error(err);
    groupMembersEmptyEl.style.display = "block";
    toast("Ø®Ø·Ø£", err?.code ? `ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ø¶ÙˆØ§Øª: ${err.code}` : "ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ø¶ÙˆØ§Øª.");
  });
}

async function loadGroupPage(){
  if(!activeGroupId) return;

  const gSnap = await getDoc(doc(db,"groups",activeGroupId));
  if(!gSnap.exists()){
    toast("Ø®Ø·Ø£","Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©.");
    __setActiveView("groups");
    return;
  }
  const g=gSnap.data();
  activeGroupGoalN = Number(g.goalN || 0) || 0;
  activeGroupName = g.name || "Ù…Ø¬Ù…ÙˆØ¹Ø©";
  groupTitleEl.textContent = activeGroupName;
  groupSubEl.textContent = `Ø§Ù„Ù‡Ø¯Ù: ${activeGroupGoalN} Ø£Ø¬Ø²Ø§Ø¡`;

  // load my selected parts
  const myMemSnap = await getDoc(doc(db,"groups",activeGroupId,"members",currentUser.uid));
  const myMem = myMemSnap.exists() ? myMemSnap.data() : {};
  pickedParts = Array.isArray(myMem.selectedParts) ? myMem.selectedParts.slice().sort((a,b)=>a-b) : [];
  pickPartsHintEl.textContent = `Ø§Ø®ØªØ§Ø±ÙŠ Ø¨Ø§Ù„Ø¶Ø¨Ø· ${activeGroupGoalN} Ø£Ø¬Ø²Ø§Ø¡ Ù„Ù‡Ø¯ÙÙƒ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©.`;
  updateMyPartsSummary();
  // (legacy hidden panel)
  renderPartsPicker();
  updatePartsPickerCount();
  // also prep modal count
  updatePartsPickerCountInto(partsPickerCountModalEl);

  await loadGroupInvites();
  listenToGroupMembers(activeGroupId);
}

async function savePickedParts(btnEl){
  if(!activeGroupId) return;
  if(pickedParts.length !== activeGroupGoalN){
    toast("ØªÙ†Ø¨ÙŠÙ‡", `Ù„Ø§Ø²Ù… ØªØ®ØªØ§Ø±ÙŠ Ø¨Ø§Ù„Ø¶Ø¨Ø· ${activeGroupGoalN} Ø£Ø¬Ø²Ø§Ø¡.`);
    return;
  }
  const b = btnEl || savePickedPartsBtn;
  if(b) b.disabled = true;
  try{
    // setDoc with merge so first-time save works too
    await setDoc(doc(db,"groups",activeGroupId,"members",currentUser.uid), {
      selectedParts: pickedParts,
      updatedAt: serverTimestamp()
    }, { merge: true });

    toast("ØªÙ…","ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡ âœ…");
    updateMyPartsSummary();
    // update my published progress for this group (in case parts changed)
    try{ const myDoc = (cachedDoc ?? await loadUserDoc()); await syncMyProgressToGroup(activeGroupId, myDoc); }catch(e){}
  }catch(e){
    console.error(e);
    toast("Ø®Ø·Ø£", e?.code ? `ØªØ¹Ø°Ø±  ${e.code}` : "ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡.");
  }finally{
    if(b) b.disabled = false;
  }
}

function openPartsModal(){
  if(!activeGroupId || !currentUser) return;
  partsModalHintEl.textContent = `Ø§Ø®ØªØ§Ø±ÙŠ Ø¨Ø§Ù„Ø¶Ø¨Ø· ${activeGroupGoalN} Ø£Ø¬Ø²Ø§Ø¡.`;
  updatePartsPickerCountInto(partsPickerCountModalEl);
  renderPartsPickerInto(partsPickerGridModalEl, partsPickerCountModalEl);
  partsOverlayEl.classList.remove("hide");
}

function closePartsModal(){
  partsOverlayEl.classList.add("hide");
}

let _memberPreviewToken = 0;
let __memberPartsUnsub = null;
function escHtml(s){
  return String(s ?? "").replace(/[&<>"']/g, (c)=>({
    "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
  }[c]));
}


/* ========= Member progress sync (safe) =========
   We cannot read other users' quranTrackers due to privacy rules.
   So each member writes a *summary* of her progress into:
   groups/{groupId}/members/{uid}
   which is readable to signed-in users (group members), while write is self-only.
*/
function buildProgressFromTracker(userDoc, selectedParts){
  const p = Array.isArray(selectedParts) ? selectedParts.slice().sort((a,b)=>a-b) : [];
  const perPart = {};
  if(!p.length) return { summary:null, perPart:{} };

  let doneCount = 0;
  let avgMem = 0;
  let avgFix = 0;

  for(const partNum of p){
    const raw = userDoc?.parts?.[String(partNum)];
    const pr = calcPartProgress(raw, partNum);
    if(pr.done) doneCount++;
    avgMem += pr.Ø­ÙØ¸Pct;
    avgFix += pr.ØªØ«Ø¨ÙŠØªPct;
    perPart[String(partNum)] = { memPct: pr.Ø­ÙØ¸Pct, fixPct: pr.ØªØ«Ø¨ÙŠØªPct, done: !!pr.done };
  }

  avgMem = Math.round(avgMem / p.length);
  avgFix = Math.round(avgFix / p.length);
  const pct = Math.round((doneCount / p.length) * 100);

  const summary = {
    total: p.length,
    done: doneCount,
    pct,
    avgMem,
    avgFix
  };
  return { summary, perPart };
}

async function syncMyProgressToGroup(groupId, userDoc){
  try{
    if(!groupId || !currentUser?.uid) return;
    // Read my selected parts in this group
    const memRef = doc(db, "groups", groupId, "members", currentUser.uid);
    const memSnap = await getDoc(memRef);
    const mem = memSnap.exists() ? (memSnap.data()||{}) : {};
    const selected = Array.isArray(mem.selectedParts) ? mem.selectedParts : [];

    const { summary, perPart } = buildProgressFromTracker(userDoc, selected);

    await setDoc(memRef, {
      progressSummary: summary,       // {total, done, pct, avgMem, avgFix} or null
      partProgress: perPart,          // {"1":{memPct,fixPct,done}, ...}
      progressUpdatedAt: serverTimestamp()
    }, { merge:true });
  }catch(e){
    console.warn("[syncMyProgressToGroup] failed", groupId, e);
  }
}

async function syncMyProgressToAllGroups(userDoc){
  try{
    if(!currentUser?.uid) return;
    const snap = await getDocs(collection(db, "userGroups", currentUser.uid, "groups"));
    const gids = [];
    snap.forEach(d=>{
      const data=d.data()||{};
      gids.push(data.groupId || d.id);
    });
    // sequential (avoid rate limits)
    for(const gid of gids){
      await syncMyProgressToGroup(gid, userDoc);
    }
  }catch(e){
    console.warn("[syncMyProgressToAllGroups] failed", e);
  }
}

let _progressSyncTimer = null;
function scheduleProgressSync(userDoc){
  try{
    if(_progressSyncTimer) clearTimeout(_progressSyncTimer);
    _progressSyncTimer = setTimeout(()=>syncMyProgressToAllGroups(userDoc), 1200);
  }catch(e){}
}
/* ========= end member progress sync ========= */

async function showMemberParts(name, parts, memberUid){
  const token = ++_memberPreviewToken;
  const p = Array.isArray(parts) ? parts.slice().sort((a,b)=>a-b) : [];

  memberPartsTitleEl.textContent = `ØªÙ‚Ø¯Ù‘Ù… ${name}`;
  memberPartsSubtitleEl.textContent = p.length ? `Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡ Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©: ${p.length}` : "Ù„Ù… ØªØ®ØªØ± Ø£Ø¬Ø²Ø§Ø¡ Ø¨Ø¹Ø¯";
  memberPartsBodyEl.innerHTML = "<div class='muted'>... Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</div>";
  memberPartsOverlayEl.classList.remove("hide");

  // If no parts, nothing else to compute
  if(!p.length){
    if(token !== _memberPreviewToken) return;
    memberPartsBodyEl.innerHTML = "<div class='muted' style='font-size:14px;line-height:1.8'>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§Ø®ØªÙŠØ§Ø±Ø§Øª Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.</div>";
    return;
  }

  
// Live read member public progress summary from:
// groups/{groupId}/members/{uid}  (safe to read for signed-in users)
try{ __memberPartsUnsub && __memberPartsUnsub(); }catch(e){}
__memberPartsUnsub = null;

if(!activeGroupId || !memberUid){
  if(token !== _memberPreviewToken) return;
  memberPartsBodyEl.innerHTML = "<div class='muted'>ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ø¶ÙˆØ©.</div>";
  return;
}

const memRef = doc(db, "groups", activeGroupId, "members", memberUid);

const renderNow = (memberMem)=>{
  // Build UI
  const header = document.createElement("div");
  header.style.marginBottom = "12px";
  
  const sum = memberMem?.progressSummary || null;
  const per = memberMem?.partProgress || null;
  
  if(!sum || !per){
    // Fallback: show parts only (still useful)
    header.innerHTML = `<div class='tag' style='text-align:right'>Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡: ${escHtml(p.join("ØŒ "))}</div>`;
    memberPartsBodyEl.innerHTML = "";
    memberPartsBodyEl.appendChild(header);
    memberPartsBodyEl.insertAdjacentHTML("beforeend",
      `<div class='muted' style='margin-top:10px;line-height:1.8'>Ù…Ù„Ø§Ø­Ø¸Ø©: Ù„Ù… ÙŠØªÙ… Ù†Ø´Ø± Ù…Ù„Ø®Ù‘Øµ Ø§Ù„ØªÙ‚Ø¯Ù‘Ù… Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ø¶ÙˆØ© Ø¨Ø¹Ø¯. ÙŠØ¸Ù‡Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¨Ø¹Ø¯ Ù‚Ø¨ÙˆÙ„Ù‡Ø§ Ø§Ù„Ø¯Ø¹ÙˆØ© Ù„Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø£Ùˆ Ø¨Ø¹Ø¯ Ø­ÙØ¸ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡.</div>`
    );
    return;
  }
  
  
  // Use the published summary (no need to read private quranTrackers)
  const doneCount = Number(sum.done || 0);
  const avgMem = Number(sum.avgMem || 0);
  const avgFix = Number(sum.avgFix || 0);
  const pct = Number(sum.pct || 0);
  
  const rows = [];
  for(const partNum of p){
    const pp = per[String(partNum)] || {};
    const pr = { Ø­ÙØ¸Pct: Number(pp.memPct||0), ØªØ«Ø¨ÙŠØªPct: Number(pp.fixPct||0), done: !!pp.done };
    rows.push({ partNum, pr });

};

__memberPartsUnsub = onSnapshot(memRef, (snap)=>{
  if(token !== _memberPreviewToken) return;
  const memberMem = snap.exists() ? (snap.data()||{}) : null;
  renderNow(memberMem);
}, (err)=>{
  console.error(err);
  if(token !== _memberPreviewToken) return;
  memberPartsBodyEl.innerHTML = "<div class='muted'>ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ø¶ÙˆØ©.</div>";
});

return;
rtsBodyEl.appendChild(list);
}
function closeMemberParts(){
  try{ __memberPartsUnsub && __memberPartsUnsub(); }catch(e){}
  __memberPartsUnsub = null;
  _memberPreviewToken++; // cancel in-flight renders
  memberPartsOverlayEl.classList.add("hide");
}

function updateMyPartsSummary(){
  if(!myPartsSummaryTextEl) return;
  const p = Array.isArray(pickedParts) ? pickedParts : [];
  myPartsSummaryTextEl.textContent = p.length ? `Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡ Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©: ${p.join("ØŒ ")}` : "Ù„Ù… ØªØ®ØªØ± Ø£Ø¬Ø²Ø§Ø¡ Ø¨Ø¹Ø¯.";
}




async function loadMyInvites(){
  // Live (onSnapshot): renders pending invites only and prevents duplicates.
  if(!currentUserEmail) return;

  // stop previous listeners (e.g., if user switches)
  try{ __invitesUnsub1 && __invitesUnsub1(); }catch(e){}
  try{ __invitesUnsub2 && __invitesUnsub2(); }catch(e){}
  __invitesUnsub1 = __invitesUnsub2 = null;

  invitesListEl.innerHTML = "";
  invitesEmptyEl.style.display = "none";

  const emailLower = normEmail(currentUserEmail);

  // Merge results from two queries for backward compatibility.
  const merged = new Map();

  const render = ()=>{
    invitesListEl.innerHTML = "";
    invitesEmptyEl.style.display = "none";

    const rows = [];
    for(const [id, inv] of merged.entries()){
      const t = inv?.createdAt?.seconds ? inv.createdAt.seconds : 0;
      rows.push({ id, inv, t });
    }
    rows.sort((a,b)=>b.t-a.t);

    if(rows.length === 0){
      invitesEmptyEl.style.display = "block";
      return;
    }

    rows.forEach(({id, inv})=>{
      const accept = document.createElement("button");
      accept.className = "miniBtn";
      accept.textContent = "Ù‚Ø¨ÙˆÙ„";
      accept.onclick = ()=>respondInvite(id, "accepted", inv);

      const decline = document.createElement("button");
      decline.className = "miniBtn";
      decline.textContent = "Ø±ÙØ¶";
      decline.onclick = ()=>respondInvite(id, "declined", inv);

      const actions = document.createElement("div");
      actions.className = "actions";
      actions.appendChild(accept);
      actions.appendChild(decline);

      const row = itemRow({
        title: inv.groupName || "Ø¯Ø¹ÙˆØ© Ù…Ø¬Ù…ÙˆØ¹Ø©",
        sub: `Ù…Ù†: ${inv.invitedByEmail || ""} â€¢ ${fmtTime(inv.createdAt)}`,
        right: actions
      });
      row.dataset.inviteId = id;
      invitesListEl.appendChild(row);
    });
  };

  const onSnap = (snap)=>{
    snap.docChanges().forEach(ch=>{
      const id = ch.doc.id;
      const inv = ch.doc.data() || {};

      if(ch.type === "removed"){
        merged.delete(id);
      }else{
        // Keep ONLY pending
        if(inv.status === "pending") merged.set(id, inv);
        else merged.delete(id);
      }
    });
    __scheduleRenderInvites(render);
  };

  const q1 = query(
    collection(db, "groupInvites"),
    where("invitedEmailLower", "==", emailLower),
    where("status", "==", "pending")
  );

  const q2 = query(
    collection(db, "groupInvites"),
    where("invitedEmail", "==", currentUserEmail),
    where("status", "==", "pending")
  );

  __invitesUnsub1 = onSnapshot(q1, onSnap, (e)=>{ console.error("invites q1 error", e); });
  __invitesUnsub2 = onSnapshot(q2, onSnap, (e)=>{ console.error("invites q2 error", e); });
}



// ===== Invite actions (accept/decline) =====
// When a member accepts an invite, she already agreed that group-related data
// (selected parts + progress summary) are visible to the group.
// So we:
// 1) mark the invite status
// 2) create membership doc + userGroups link
// 3) publish progress summary for that group immediately (safe: reads only her own tracker)
async function respondInvite(inviteId, newStatus, inv){
  try{
    if(!inviteId) return;

    // 1) update invite status
    await updateDoc(doc(db, "groupInvites", inviteId), {
      status: newStatus,
      respondedAt: serverTimestamp(),
      respondedByUid: currentUser?.uid || null,
      respondedByEmail: currentUserEmail || null
    });

    // 2) if accepted, add membership + userGroups
    if(newStatus === "accepted"){
      const groupId = inv?.groupId;
      if(!groupId){
        toast("Ø®Ø·Ø£","Ø§Ù„Ø¯Ø¹ÙˆØ© ØºÙŠØ± ØµØ§Ù„Ø­Ø© (groupId Ù…ÙÙ‚ÙˆØ¯). ");
      }else{
        // read group meta (goal/name) once
        const gSnap = await getDoc(doc(db, "groups", groupId));
        const g = gSnap.exists() ? (gSnap.data()||{}) : {};

        const batch = writeBatch(db);
        batch.set(doc(db, "groups", groupId, "members", currentUser.uid), {
          uid: currentUser.uid,
          email: currentUserEmail,
          displayName: currentUser.displayName || "",
          role: "member",
          joinedAt: serverTimestamp()
        }, { merge:true });

        batch.set(doc(db, "userGroups", currentUser.uid, "groups", groupId), {
          groupId,
          name: g.name || inv?.groupName || "Ù…Ø¬Ù…ÙˆØ¹Ø©",
          goalType: g.goalType || "juz_count",
          goalN: Number(g.goalN || 0) || 0,
          role: "member",
          joinedAt: serverTimestamp()
        }, { merge:true });

        await batch.commit();

        // 3) publish progress summary now (so others don't see the warning)
        try{
          const myDoc = (cachedDoc ?? await loadUserDoc());
          await syncMyProgressToGroup(groupId, myDoc);
        }catch(e){ /* silent */ }

        toast("ØªÙ…", "ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø¯Ø¹ÙˆØ© âœ…");
      }
    }else{
      toast("ØªÙ…", newStatus === "declined" ? "ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø¯Ø¹ÙˆØ©." : "ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯Ø¹ÙˆØ©.");
    }

    // refresh lists
    await loadMyInvites();
    await loadMyGroups();

  }catch(e){
    console.error(e);
    toast("Ø®Ø·Ø£", e?.code ? `ØªØ¹Ø°Ø± ØªÙ†ÙÙŠØ° Ø§Ù„Ø¹Ù…Ù„ÙŠØ©: ${e.code}` : "ØªØ¹Ø°Ø± ØªÙ†ÙÙŠØ° Ø§Ù„Ø¹Ù…Ù„ÙŠØ©.");
  }
}

// Guard against double execution (double-click, duplicated listeners, form submit, etc.)
let __creatingGroup = false;
async function createGroup(){
  if(__creatingGroup) return;
  __creatingGroup = true;
  createGroupBtn && (createGroupBtn.disabled = true, createGroupBtn.style.pointerEvents = "none");
  const name = (groupNameEl.value || "").trim();
  const n = Number(groupNEl.value || 0);

  if(!currentUser){ toast("ØªÙ†Ø¨ÙŠÙ‡", "Ø³Ø¬Ù‘Ù„ÙŠ Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹."); return; }
  if(!name){ toast("ØªÙ†Ø¨ÙŠÙ‡", "Ø§ÙƒØªØ¨ÙŠ Ø§Ø³Ù… Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©."); return; }
  if(!n || n<1 || n>30){ toast("ØªÙ†Ø¨ÙŠÙ‡", "Ø§Ø®ØªØ§Ø±ÙŠ Ø¹Ø¯Ø¯ Ø£Ø¬Ø²Ø§Ø¡ ØµØ­ÙŠØ­ (1â€“30)."); return; }

  
  try{
    // Create id first so we can write multiple docs atomically
    const gRef = doc(collection(db, "groups"));
    const groupId = gRef.id;

    const batch = writeBatch(db);

    // 1) group doc
    batch.set(gRef, {
      name,
      goalType: "juz_count",
      goalN: n,
      createdByUid: currentUser.uid,
      createdByEmail: currentUserEmail,
      createdAt: serverTimestamp()
    });

    // 2) membership doc
    batch.set(doc(db, "groups", groupId, "members", currentUser.uid), {
      uid: currentUser.uid,
      email: currentUserEmail,
      displayName: currentUser.displayName || "",
      role: "owner",
      joinedAt: serverTimestamp(),
      selectedParts: []
    }, { merge:true });

    // 3) userGroups link (THIS is what makes it persist in "Ù…Ø¬Ù…ÙˆØ¹Ø§ØªÙŠ")
    batch.set(doc(db, "userGroups", currentUser.uid, "groups", groupId), {
      groupId,
      name,
      goalType: "juz_count",
      goalN: n,
      role: "owner",
      joinedAt: serverTimestamp()
    }, { merge:true });

    await batch.commit();

    createdGroupMetaEl.textContent = `Ø§Ù„Ù‡Ø¯Ù: ${n} Ø£Ø¬Ø²Ø§Ø¡ â€¢ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø¥Ø±Ø³Ø§Ù„ Ø¯Ø¹ÙˆØ§Øª Ø¨Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„.`;
    createdGroupBoxEl.style.display = "block";
    toast("ØªÙ…", "ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© âœ…");

    // refresh lists
    await loadMyGroups();

    // optional: if group page exists in this build, open it
    try{ if(typeof openGroupPage==="function") await openGroupPage(groupId); }catch(e){ console.error(e); }

  }catch(e){
    console.error(e);
    toast("Ø®Ø·Ø£", e?.code ? `ØªØ¹Ø°Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©: ${e.code}` : "ØªØ¹Ø°Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©.");
  }finally{
    createGroupBtn.disabled = false;
    __creatingGroup = false;
  }
}

async function loadSentInvites(){
  // Live (onSnapshot): show pending invites for the selected/created group.
  // When the invite is accepted/declined, it disappears automatically here.
  if(!createdGroupId) return;

  try{ __sentInvitesUnsub && __sentInvitesUnsub(); }catch(e){}
  __sentInvitesUnsub = null;

  sentInvitesListEl.innerHTML = "";
  sentInvitesEmptyEl.style.display = "none";

  const q = query(
    collection(db, "groupInvites"),
    where("groupId", "==", createdGroupId),
    where("status", "==", "pending")
  );

  __sentInvitesUnsub = onSnapshot(q, (snap)=>{
    sentInvitesListEl.innerHTML = "";
    sentInvitesEmptyEl.style.display = "none";

    if(snap.empty){
      sentInvitesEmptyEl.textContent = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯Ø¹ÙˆØ§Øª Ù…Ø¹Ù„Ù‘Ù‚Ø©.";
      sentInvitesEmptyEl.style.display = "block";
      return;
    }

    const rows=[];
    snap.forEach(d=>{
      const inv = d.data() || {};
      const t = inv?.createdAt?.seconds ? inv.createdAt.seconds : 0;
      rows.push({id:d.id, inv, t});
    });
    rows.sort((a,b)=>b.t-a.t);

    rows.forEach(({id, inv})=>{
      const row = itemRow({
        title: inv.invitedEmail,
        sub: `Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù‚Ø¨ÙˆÙ„ â€¢ ${fmtTime(inv.createdAt)}`,
        right: null
      });
      row.dataset.inviteId = id;
      sentInvitesListEl.appendChild(row);
    });
  }, (e)=>{ console.error("sentInvites listener error", e); });
}



async function sendInvite(){
  if(!createdGroupId){ toast("ØªÙ†Ø¨ÙŠÙ‡", "Ø£Ù†Ø´Ø¦ÙŠ Ù…Ø¬Ù…ÙˆØ¹Ø© Ø£ÙˆÙ„Ø§Ù‹."); return; }
  const emailRaw = (inviteEmailEl.value || "").trim();
  const emailLower = normEmail(emailRaw);
  if(!emailLower || !emailLower.includes("@")){ toast("ØªÙ†Ø¨ÙŠÙ‡", "Ø§ÙƒØªØ¨ÙŠ Ø¥ÙŠÙ…ÙŠÙ„ ØµØ­ÙŠØ­."); return; }
  if(!currentUser){ toast("ØªÙ†Ø¨ÙŠÙ‡", "Ø³Ø¬Ù‘Ù„ÙŠ Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹."); return; }

  sendInviteBtn.disabled = true;
  try{
    const gSnap = await getDoc(doc(db, "groups", createdGroupId));
    const g = gSnap.exists() ? gSnap.data() : { name: "Ù…Ø¬Ù…ÙˆØ¹Ø©" };

    const invId = inviteDocId(createdGroupId, emailLower);
    const invRef = doc(db, "groupInvites", invId);
    const invSnap = await getDoc(invRef);

    if(invSnap.exists()){
      const prev = invSnap.data() || {};
      if(prev.status === "pending"){ toast("ØªÙ†Ø¨ÙŠÙ‡","Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø¹ÙˆØ© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„ (Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù‚Ø¨ÙˆÙ„)."); return; }
      if(prev.status === "accepted"){ toast("ØªÙ†Ø¨ÙŠÙ‡","ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø¯Ø¹ÙˆØ© Ø³Ø§Ø¨Ù‚Ù‹Ø§."); return; }
    }

    await setDoc(invRef, {
      groupId: createdGroupId,
      groupName: g.name || "Ù…Ø¬Ù…ÙˆØ¹Ø©",
      invitedEmail: emailLower,
      invitedEmailLower: emailLower,
      invitedByUid: currentUser.uid,
      invitedByEmail: currentUserEmail,
      status: "pending",
      createdAt: serverTimestamp(),
      resentAt: invSnap.exists() ? serverTimestamp() : null
    }, { merge:true });

    inviteEmailEl.value = "";
    toast("ØªÙ…", "ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¯Ø¹ÙˆØ© âœ…");
    await loadSentInvites();
  }catch(e){
    console.error(e);
    toast("Ø®Ø·Ø£", "ØªØ¹Ø°Ø± Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¯Ø¹ÙˆØ©.");
  }finally{
    sendInviteBtn.disabled = false;
  }
}


  let uid = null;
  let currentPart = null;
  let cachedDoc = null;

  async function loadUserDoc(){
    const ref = doc(db, "quranTrackers", uid);
    const snap = await getDoc(ref);
    if(snap.exists()) return snap.data();
    return { profile:{}, parts:{} };
  }
  async function saveUserDoc(userDoc){
    const ref = doc(db, "quranTrackers", uid);
    // keep a last-updated timestamp and sync progress summaries to all groups
    await setDoc(ref, { ...userDoc, updatedAt: serverTimestamp() }, { merge:true });
    try{ scheduleProgressSync(userDoc); }catch(e){}
  }

  function setGreeting(userDoc){
    const name = userDoc.profile?.name?.trim();
    greetEl.textContent = name ? ("") : "";
    globalLastEl.textContent = userDoc.updatedAt ? ("Ø¢Ø®Ø± ØªØ¹Ø¯ÙŠÙ„: " + fmtDate(userDoc.updatedAt)) : "";
  }

  function maybeHelloToast(userDoc){ return; }

  // Name modal
  function showNameModal(show){
    el("nameOverlay").classList.toggle("hide", !show);
    el("displayName").value = "";
    el("nameStatus").textContent = show ? "Ø§ÙƒØªØ¨ÙŠ Ø§Ø³Ù…Ùƒ Ù„Ù„ØªØ±Ø­ÙŠØ¨ ğŸŒ¸" : "âœ¨";
  }

  el("saveNameBtn").addEventListener("click", async ()=>{
    const nm = el("displayName").value.trim();
    if(!nm){ el("nameStatus").textContent = "Ø§ÙƒØªØ¨ÙŠ Ø§Ø³Ù…Ù‹Ø§ Ø£ÙˆÙ„Ø§Ù‹."; return; }
    try{
      const userDoc = (cachedDoc ?? await loadUserDoc());
      userDoc.profile = userDoc.profile || {};
      userDoc.profile.name = nm;
      await saveUserDoc(userDoc);
      cachedDoc = userDoc;

      scheduleProgressSync(userDoc);
      setGreeting(userDoc);
      showNameModal(false);
      showToast("Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ… ÙŠØ§ " + nm);
      // show intro after name set if not seen
      if(!userDoc.profile?.seenIntro){ openIntro(); }
    }catch(e){
      console.error(e);
      el("nameStatus").textContent = "ØªØ¹Ø°Ø± Ø§Ù„Ø­ÙØ¸ØŒ Ø¬Ø±Ù‘Ø¨ÙŠ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.";
    }
  });

  el("skipNameBtn").addEventListener("click", async ()=>{
    showNameModal(false);
    const userDoc = (cachedDoc ?? await loadUserDoc());
    if(!userDoc.profile?.seenIntro){ openIntro(); }
  });

  async function markIntroSeen(){
    if(!uid) return;
    try{
      const userDoc = (cachedDoc ?? await loadUserDoc());
      userDoc.profile = userDoc.profile || {};
      userDoc.profile.seenIntro = true;
      userDoc.updatedAt = new Date().toISOString();
      await saveUserDoc(userDoc);
      cachedDoc = userDoc;
      setGreeting(userDoc);
    }catch(e){
      console.error(e);
    }
  }

  // autosave debounce
  let autosaveTimer = null;
  let saving = false;
  let pending = false;

  function scheduleAutosave(){
    if(!uid || !currentPart) return;
    if(autosaveTimer) clearTimeout(autosaveTimer);
    autosaveTimer = setTimeout(()=> autosaveNow(), 900);
  }

  async function autosaveNow(){
    if(!uid || !currentPart) return;
    if(saving){ pending = true; return; }
    saving = true;
    try{
      const userDoc = (cachedDoc ?? await loadUserDoc());
      userDoc.parts = userDoc.parts || {};
      userDoc.profile = userDoc.profile || {};

      userDoc.parts[String(currentPart)] = collectPart(currentPart);
      userDoc.updatedAt = new Date().toISOString();

      await saveUserDoc(userDoc);
      cachedDoc = userDoc;

      const part = userDoc.parts[String(currentPart)];
      lastSavedEl.textContent = "Ø¢Ø®Ø± ØªØ¹Ø¯ÙŠÙ„: " + fmtDate(part.updatedAt);
      setGreeting(userDoc);
    }catch(e){
      console.error(e);
    }finally{
      saving = false;
      if(pending){ pending = false; autosaveNow(); }
    }
  }

  
// --- Dash view switcher (My / Groups) ---
function setDashView(which){
  localStorage.setItem("dashView", which);

  const viewMyEl = el("viewMy");
  const viewGroupsEl = el("viewGroups");
  const navMyBtn = el("navMy");
  const navGroupsBtn = el("navGroups");

  if(viewMyEl && viewGroupsEl){
    viewMyEl.classList.toggle("show", which === "my");
    viewGroupsEl.classList.toggle("show", which === "groups");
  }
  if(navMyBtn && navGroupsBtn){
    navMyBtn.classList.toggle("active", which === "my");
    navGroupsBtn.classList.toggle("active", which === "groups");
  }

  if(which === "groups"){
    // force load groups every time we enter the tab
    console.log("[ui] entering groups tab -> loading groups");
    if(!currentUser){
      // user clicked before auth state is ready â€” defer until onAuthStateChanged fires
      pendingGroupsLoad = true;
      return;
    }
    pendingGroupsLoad = false;
    loadMyGroups().catch(console.error);
    loadMyInvites().catch(console.error);
    // safety: run again shortly in case DOM just switched
    setTimeout(()=>{ loadMyGroups().catch(console.error); }, 150);
  }
}

function wireDashNav(){
  try{ el("navMy")?.addEventListener("click", ()=>setDashView("my")); }catch(e){console.error(e);}
  try{ el("navGroups")?.addEventListener("click", ()=>setDashView("groups")); }catch(e){console.error(e);}
  try{ el("bottomMy")?.addEventListener("click", ()=>setDashView("my")); }catch(e){console.error(e);}
  try{ el("bottomGroups")?.addEventListener("click", ()=>setDashView("groups")); }catch(e){console.error(e);}
}

wireDashNav();

async function openDash(){
    cachedDoc = await loadUserDoc();
    setGreeting(cachedDoc);
    buildPartsGrid(cachedDoc);
    showOnly("dash");
    setDashView(localStorage.getItem("dashView") || "my");

    maybeHelloToast(cachedDoc);

    if(!cachedDoc.profile?.name){
      showNameModal(true);
    }else{
      if(!cachedDoc.profile?.seenIntro){ openIntro(); }
    }
  }

  async function openPart(partNum){
    cachedDoc = await loadUserDoc();
    setGreeting(cachedDoc);
    currentPart = partNum;
    loadPartToUI(partNum, cachedDoc);
    showOnly("part");

    maybeHelloToast(cachedDoc);
  }

  // Help button shows wizard anytime
  el("helpBtn").addEventListener("click", openIntro);

  // Auth actions
  el("googleBtn").addEventListener("click", async ()=>{
    try{
      setAuthStatus("Ø¬Ø§Ø±ÙŠ ÙØªØ­ Google...", "");
      const provider = new GoogleAuthProvider();
      await signInWithPopup(auth, provider);
      setAuthStatus("ØªÙ… âœ…", "ok");
    }catch(e){
      console.error(e);
      setAuthStatus(friendlyAuthError(e.code), "warn");
    }
  });

  el("signInBtn").addEventListener("click", async ()=>{
    try{
      setAuthStatus("Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...", "");
      await signInWithEmailAndPassword(auth, el("email").value.trim(), el("password").value);
      setAuthStatus("ØªÙ… âœ…", "ok");
    }catch(e){
      console.error(e);
      setAuthStatus(friendlyAuthError(e.code), "warn");
    }
  });

  el("signUpBtn").addEventListener("click", async ()=>{
    try{
      setAuthStatus("Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨...", "");
      await createUserWithEmailAndPassword(auth, el("email").value.trim(), el("password").value);
      setAuthStatus("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ âœ…", "ok");
    }catch(e){
      console.error(e);
      setAuthStatus(friendlyAuthError(e.code), "warn");
    }
  });

  el("resetPwBtn").addEventListener("click", async ()=>{
    const email = el("email").value.trim();
    if(!email){ setAuthStatus("Ø§ÙƒØªØ¨ÙŠ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹.", "warn"); return; }
    try{
      await sendPasswordResetEmail(auth, email);
      setAuthStatus("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ† âœ…", "ok");
    }catch(e){
      console.error(e);
      setAuthStatus(friendlyAuthError(e.code), "warn");
    }
  });

  el("backBtn").addEventListener("click", async ()=>{
    if(autosaveTimer){ clearTimeout(autosaveTimer); await autosaveNow(); }
    await openDash();

      // If the saved active view is "groups" (or user clicked Groups before auth was ready),
      // make sure we actually load groups immediately.
      try{
        const wantsGroups =
          (localStorage.getItem("activeView")==="groups") ||
          (localStorage.getItem("dashView")==="groups") ||
          pendingGroupsLoad;
        if(wantsGroups){
          setDashView("groups");
        }
      }catch(e){ console.error(e); }

      // Restore last dash view (and load groups if needed)
      setDashView(localStorage.getItem('dashView') || 'my');

      try{ await loadMyInvites(); }catch(e){ console.error(e); }
      try{ await loadMyGroups(); }catch(e){ console.error(e); }
  });

  el("logoutBtn").addEventListener("click", async ()=>{ await signOut(auth); });
  el("logoutBtn2").addEventListener("click", async ()=>{ await signOut(auth); });

  onAuthStateChanged(auth, async (user)=>{
    if(user){
      currentUser = user;
      window.currentUser = user;
      currentUserEmail = normEmail(user.email);
      uid = user.uid;
      await openDash();
    }else{
      uid = null; currentPart = null; cachedDoc = null;
      greetEl.textContent = "";
      globalLastEl.textContent = "";
      showOnly("auth");
      setAuthStatus("Ø³Ø¬Ù‘Ù„ÙŠ Ø¯Ø®ÙˆÙ„Ùƒ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©.", "");
      sessionStorage.removeItem("helloShown");
    }
  });
// ===== Groups: UI listeners =====
if (createGroupBtn && !createGroupBtn.dataset.bound) {
  createGroupBtn.dataset.bound = "1";
  createGroupBtn.addEventListener("click", createGroup);
}
  backToGroupsFromGroupBtn?.addEventListener("click", ()=>__setActiveView("groups"));
  groupSendInviteBtn?.addEventListener("click", sendGroupInvite);

  // ===== Parts (Popup) =====
  editMyPartsBtn?.addEventListener("click", openPartsModal);
  partsModalCloseBtn?.addEventListener("click", closePartsModal);
  partsModalCancelBtn?.addEventListener("click", closePartsModal);
  // close when clicking on overlay background
  partsOverlayEl?.addEventListener("click", (e)=>{ if(e.target===partsOverlayEl) closePartsModal(); });

  partsModalSaveBtn?.addEventListener("click", async ()=>{
    await savePickedParts(partsModalSaveBtn);
    closePartsModal();
  });

  // ===== Member parts (view) =====
  memberPartsCloseBtn?.addEventListener("click", closeMemberParts);
  memberPartsOkBtn?.addEventListener("click", closeMemberParts);
  memberPartsOverlayEl?.addEventListener("click", (e)=>{ if(e.target===memberPartsOverlayEl) closeMemberParts(); });

  groupInviteEmailEl?.addEventListener("keydown", (e)=>{ if(e.key==="Enter") sendGroupInvite(); });
  savePickedPartsBtn?.addEventListener("click", savePickedParts);

backToGroupsBtn?.addEventListener("click", ()=>window.__setActiveView?.("groups"));
sendInviteBtn?.addEventListener("click", sendInvite);
inviteEmailEl?.addEventListener("keydown", (e)=>{ if(e.key==="Enter") sendInvite(); });
refreshGroupsBtn?.addEventListener("click", async ()=>{ await loadMyInvites(); await loadMyGroups(); });

// When view changes (inside the shell navigator), refresh groups automatically.
// Important: __setActiveView is created in the non-module script on DOMContentLoaded,
// so we wrap it AFTER DOMContentLoaded to avoid "undefined" at module load time.
window.addEventListener("DOMContentLoaded", ()=>{
  try{
    const _oldSetActive = window.__setActiveView;
    if(typeof _oldSetActive === "function" && !_oldSetActive.__wrappedForGroups){
      const wrapped = (which)=>{
        _oldSetActive(which);
        // Stop realtime members listener when leaving the group view
        if(which !== "group"){
          try{ if(membersUnsub) membersUnsub(); }catch(e){}
          membersUnsub = null;
        }
        if(which==="groups"){
          // refresh lists
          loadMyInvites().catch(console.error);
          loadMyGroups().catch(console.error);
        }
        if(which==="group"){
          loadGroupPage().catch(console.error);
        }
      };
      wrapped.__wrappedForGroups = true;
      window.__setActiveView = wrapped;
    }
  }catch(e){ console.error(e); }
});

// After login, load lists
// (called from auth state handler below)

// Expose some actions for safety (in case any inline handlers exist)
window.sendInvite = sendInvite;
window.createGroup = createGroup;
window.openGroupPage = openGroupPage;


window.showToast = showToast;
window.setDashView = setDashView;
window.loadMyGroups = loadMyGroups;
try{ el('navGroups')?.addEventListener('click', openGroupsTab); }catch(e){console.error(e);} 
try{ el('bottomGroups')?.addEventListener('click', openGroupsTab); }catch(e){console.error(e);} 

window.openGroupsTab = openGroupsTab;
try{ el("navMy")?.addEventListener("click", ()=>setDashView("my")); }catch(e){console.error(e);} 
try{ el("navGroups")?.addEventListener("click", ()=>setDashView("groups")); }catch(e){console.error(e);} 
try{ el("bottomMy")?.addEventListener("click", ()=>setDashView("my")); }catch(e){console.error(e);} 
try{ el("bottomGroups")?.addEventListener("click", ()=>setDashView("groups")); }catch(e){console.error(e);}

function bindDashNav(){
  const bind = (id, which)=>{
    const b = el(id);
    if(!b) return;
    b.addEventListener("click", (e)=>{
      e.preventDefault();
      console.log(`[ui] click ${id} -> ${which}`);
      setDashView(which);
    }, { passive:false });
  };
  bind("navMy","my");
  bind("mNavMy","my");
  bind("bottomMy","my");
  bind("navGroups","groups");
  bind("mNavGroups","groups");
  bind("bottomGroups","groups");
  bind("goCreateFromGroups","groups"); // keep dashView in sync when opening groups then create
}

// bind once after module loads
bindDashNav();
</script>

<!-- Mobile Bottom Navigation -->
<nav class="bottomNav" id="bottomNav">
  <div class="bottomNavInner">
    <button class="bottomBtn active" id="mNavMy" type="button">
      <div class="ico" aria-hidden="true"><svg viewBox="0 0 24 24" width="22" height="22"><path fill="currentColor" d="M12 12a4.2 4.2 0 1 0-4.2-4.2A4.2 4.2 0 0 0 12 12Zm0 2c-4.1 0-7.5 2.2-7.5 5v1h15v-1c0-2.8-3.4-5-7.5-5Z"/></svg></div>
      <div>ØµÙØ­ØªÙŠ</div>
    </button>
    <button class="bottomBtn" id="mNavGroups" type="button">
      <div class="ico" aria-hidden="true"><svg viewBox="0 0 24 24" width="22" height="22"><path fill="currentColor" d="M16.5 13c-2.6 0-4.8 1.3-5.5 3.2.6.7 1 1.5 1 2.3V20h9v-1.5c0-3-2.2-5.5-4.5-5.5ZM8.5 13c-3.3 0-6 2-6 4.5V20h9v-1.5c0-2.5-2.7-5.5-3-5.5Zm0-2a3 3 0 1 0-3-3 3 3 0 0 0 3 3Zm8 0a2.5 2.5 0 1 0-2.5-2.5A2.5 2.5 0 0 0 16.5 11Z"/></svg></div>
      <div>Ù…Ø¬Ù…ÙˆØ¹Ø§ØªÙŠ</div>
    </button>
    <button class="bottomBtn" id="mNavMore" type="button">
      <div class="ico" aria-hidden="true" style="font-weight:900;font-size:20px;line-height:1">â‹¯</div>
      <div>Ø§Ù„Ù…Ø²ÙŠØ¯</div>
    </button>
  </div>
</nav>

<!-- Bottom Sheet -->
<div class="sheetBackdrop" id="sheetBackdrop"></div>
<div class="bottomSheet" id="bottomSheet" aria-hidden="true">
  <div class="sheetHandle"></div>
  <button class="sheetItem" id="sheetLogout" type="button">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
</div>


<!-- Ø£Ø¬Ø²Ø§Ø¡: Ø§Ø®ØªÙŠØ§Ø±/ØªØ¹Ø¯ÙŠÙ„ (Popup) -->
<div id="partsOverlay" class="overlay hide" role="dialog" aria-modal="true">
  <div class="modal" style="width:min(720px,100%)">
    <div class="modalHd">
      <div>
        <div class="modalTitle">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø£Ø¬Ø²Ø§Ø¡</div>
        <div class="muted" id="partsModalHint">Ø§Ø®ØªØ§Ø±ÙŠ Ø¨Ø§Ù„Ø¶Ø¨Ø· N Ø£Ø¬Ø²Ø§Ø¡.</div>
      </div>
      <button class="iconBtn" id="partsModalClose" type="button" aria-label="Ø¥ØºÙ„Ø§Ù‚">âœ•</button>
    </div>
    <div class="modalBd">
      <div id="partsPickerGridModal" class="partsGrid"></div>
      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;align-items:center;justify-content:space-between">
        <div class="muted" id="partsPickerCountModal">0 / 0</div>
        <div style="display:flex;gap:10px">
          <button class="btn btnGhost" id="partsModalCancel" type="button">Ø¥Ù„ØºØ§Ø¡</button>
          <button class="btn" id="partsModalSave" type="button">ØªÙ…</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Ø¹Ø±Ø¶ Ø£Ø¬Ø²Ø§Ø¡ Ø¹Ø¶ÙˆØ© -->
<div id="memberPartsOverlay" class="overlay hide" role="dialog" aria-modal="true">
  <div class="modal" style="width:min(520px,100%)">
    <div class="modalHd">
      <div>
        <div class="modalTitle" id="memberPartsTitle">Ø§Ø®ØªÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¹Ø¶ÙˆØ©</div>
        <div class="muted" id="memberPartsSubtitle"></div>
      </div>
      <button class="iconBtn" id="memberPartsClose" type="button" aria-label="Ø¥ØºÙ„Ø§Ù‚">âœ•</button>
    </div>
    <div class="modalBd">
      <div id="memberPartsBody" class="muted" style="font-size:14px;line-height:1.8"></div>
      <div style="display:flex;justify-content:flex-end;margin-top:14px">
        <button class="btn" id="memberPartsOk" type="button">ØªÙ…Ø§Ù…</button>
      </div>
    </div>
  </div>
</div>

</body>
</html>
